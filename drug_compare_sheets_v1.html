<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>DrugCompare â€“ è®€å– Google Sheets</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{--p:#6554f6;--pl:#ebe9ff;--bg:#f5f5fb;--t:#1f2933;--s:#7b8794;}
    *{box-sizing:border-box}
    body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",system-ui,sans-serif;background:var(--bg);color:var(--t)}
    .app{max-width:520px;margin:0 auto;min-height:100vh;background:#fff;box-shadow:0 0 30px rgba(0,0,0,.06)}
    header{padding:14px 18px 8px;position:sticky;top:0;background:#fff;z-index:9}
    .brand{font-weight:800;color:var(--p);font-size:18px}
    .brand span{font-weight:500;color:var(--s);font-size:12px;margin-left:6px}
    main{padding:0 14px 70px;background:linear-gradient(180deg,#f5f5fb 0%,#fff 40%)}
    .screen{display:none;animation:in .18s ease-out}
    .screen.active{display:block}
    @keyframes in{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:translateY(0)}}
    .title{font-size:18px;font-weight:700;margin:8px 0 10px}
    .card{background:#fff;border-radius:16px;padding:12px;box-shadow:0 8px 18px rgba(15,23,42,.08);margin-bottom:10px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .btn{border:none;border-radius:999px;padding:8px 12px;background:var(--p);color:#fff;font-size:13px;cursor:pointer}
    .btn.secondary{background:#e5e7eb;color:#374151}
    .inp{width:100%;border:1px solid #e5e7eb;border-radius:12px;padding:10px 12px;background:#fff;font-size:14px;outline:none}
    .small{font-size:12px;color:var(--s);line-height:1.4}
    .pill{display:inline-flex;background:#eef2ff;border-radius:999px;padding:4px}
    .pill button{border:none;background:transparent;border-radius:999px;padding:7px 12px;font-size:12px;color:var(--s);cursor:pointer}
    .pill button.active{background:#fff;color:var(--p);box-shadow:0 4px 10px rgba(101,84,246,.25)}
    .list{display:flex;flex-direction:column;gap:10px}
    .item{display:flex;gap:12px;align-items:flex-start;background:#fff;border-radius:16px;padding:10px;box-shadow:0 6px 14px rgba(15,23,42,.1);cursor:pointer}
    .thumb{width:56px;height:56px;border-radius:16px;background:#e5e7f5;overflow:hidden;display:flex;align-items:center;justify-content:center;font-size:11px;color:var(--s);flex:0 0 auto}
    .thumb img{width:100%;height:100%;object-fit:cover}
    .name{font-size:14px;font-weight:700;margin-bottom:2px}
    .spec{font-size:11px;color:var(--s);margin-bottom:6px}
    .meta{display:flex;justify-content:space-between;align-items:center;margin-bottom:2px}
    .tag{font-size:10px;padding:2px 8px;border-radius:999px;background:#f3f4ff;color:var(--p)}
    .sum{font-size:11px;color:var(--s)}
    .sum strong{font-size:13px;color:var(--p)}
    .nav{position:fixed;left:50%;bottom:0;transform:translateX(-50%);width:100%;max-width:520px;background:#fff;border-top:1px solid #e0e5f2;padding:6px 22px 10px;display:flex}
    .nav .n{flex:1;text-align:center;font-size:10px;color:var(--s);cursor:pointer}
    .nav .i{width:22px;height:22px;border-radius:999px;margin:0 auto 2px;display:flex;align-items:center;justify-content:center;font-size:13px;color:var(--s)}
    .nav .n.active{color:var(--p)}
    .nav .n.active .i{background:var(--p);color:#fff}
    /* bottom sheet */
    .backdrop{position:fixed;inset:0;background:rgba(15,23,42,.45);display:none;align-items:flex-end;justify-content:center;z-index:50}
    .backdrop.active{display:flex}
    .sheet{width:100%;max-width:520px;background:#fff;border-radius:20px 20px 0 0;padding:12px 14px 16px;max-height:82vh;overflow:auto;box-shadow:0 -6px 18px rgba(0,0,0,.25)}
    .handle{width:36px;height:4px;border-radius:999px;background:#e5e7eb;margin:0 auto 10px}
    .sheet h3{margin:0 0 4px;font-size:16px}
    .sheet .sub{font-size:12px;color:var(--s);margin-bottom:10px}
    .block{background:#f9fafb;border-radius:14px;padding:10px;margin-bottom:10px}
    .block .bt{font-weight:700;font-size:13px;margin-bottom:6px}
    .sr{display:flex;justify-content:space-between;gap:12px;margin-bottom:6px}
    .sn{font-weight:600}
    .note{font-size:11px;color:var(--s)}
    .line{font-size:12px}
  

  .fab{
    display: none;
    position: fixed;
    right: calc(50% - 260px + 16px);
    bottom: 78px;
    width: 52px;
    height: 52px;
    border-radius: 999px;
    border: none;
    background: var(--p);
    color: #fff;
    font-size: 26px;
    box-shadow: 0 14px 30px rgba(101,84,246,.35);
    cursor: pointer;
    z-index: 60;
  }
  @media (max-width: 520px){
    .fab{ right: 16px; }
  }


    .stripe{width:6px;border-radius:16px 0 0 16px;flex:0 0 6px}
    .catPill{display:inline-flex;align-items:center;gap:6px;font-size:10px;padding:2px 8px;border-radius:999px;color:#fff}
    .catPillDot{width:6px;height:6px;border-radius:999px;background:rgba(255,255,255,.85)}


    .catSection{margin:12px 2px 8px;font-weight:800;font-size:14px;display:flex;align-items:center;gap:8px}
    .catDot{width:10px;height:10px;border-radius:999px;display:inline-block}
    .catSection .small{margin-left:auto}
.catCard{border-radius:18px;padding:10px 10px 2px;margin:10px 0;box-shadow:0 6px 14px rgba(15,23,42,.06)}
.catCardInner{display:flex;flex-direction:column;gap:10px}
.catHeader{display:flex;align-items:center;gap:8px;margin:2px 2px 6px;font-weight:900}
.catHeader .small{margin-left:auto}


.sortable{display:flex;flex-direction:column;gap:10px}
.sortItem{display:flex;align-items:center;gap:10px;background:#fff;border-radius:14px;padding:10px;box-shadow:0 4px 10px rgba(15,23,42,.08);touch-action:none}
.sortHandle{width:34px;height:34px;border-radius:10px;background:#f3f4ff;color:var(--p);display:flex;align-items:center;justify-content:center;font-weight:900;cursor:grab;flex:0 0 auto}
.sortMeta{flex:1;min-width:0}
.sortName{font-weight:800;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.sortId{font-size:11px;color:var(--s)}
.sortBadge{font-size:10px;padding:3px 8px;border-radius:999px;background:#eef2ff;color:var(--p)}
.sortItem.dragging{opacity:.75;transform:scale(.99)}

</style>
</head>
<body>
<div class="app">
  <header>
    <div class="brand">DrugCompare <span>Google Sheets ç‰ˆ</span></div>
  </header>

  <main>
    <!-- Home -->
    <section id="home" class="screen active">
      <div class="title">é¦–é </div>

      <div class="card">
        <div style="font-weight:700;margin-bottom:6px;">è³‡æ–™ä¾†æºï¼ˆGoogle Sheetsï¼‰</div>
        <div class="small" id="sourceInfo">å°šæœªè¨­å®šã€‚è«‹åˆ°ã€Œè¨­å®šã€è²¼ä¸Šè©¦ç®—è¡¨ç¶²å€æˆ– Sheet IDã€‚</div>
        <div class="row" style="margin-top:10px;">
          <button class="btn" onclick="openList('all')">æŸ¥çœ‹å•†å“</button>
          <button class="btn secondary" onclick="openSettings()">è¨­å®š</button>
        </div>
      </div>

      <div class="card">
        <div style="font-weight:700;margin-bottom:6px;">å¿«é€Ÿèªªæ˜</div>
        <div class="small">
          1) ä½ çš„è©¦ç®—è¡¨éœ€æœ‰ä¸‰å€‹åˆ†é ï¼šcategories / stores / productsã€‚<br/>
          2) å…±äº«æ¬Šé™éœ€å…è¨±ä»»ä½•æœ‰é€£çµçš„äººæª¢è¦–ï¼ˆæˆ–ç™¼ä½ˆåˆ°ç¶²è·¯ï¼‰ã€‚<br/>
          3) App æœƒè‡ªå‹•ç”¨ã€Œé¡åˆ¥ã€çš„åŒ¯ç‡èˆ‡ç¨…ç‡è¨ˆç®—æ—¥æœ¬åƒ¹æ ¼æ›ç®—ã€‚
        </div>
      </div>
    </section>

    <!-- List -->
    <section id="list" class="screen">
      <div class="row" style="margin-top:8px;justify-content:space-between;">
        <div style="font-weight:800;font-size:18px;">å•†å“</div>
        <div class="pill">
          <button id="f_all" class="active" onclick="setFilter('all')">å…¨éƒ¨</button>
          <button id="f_tw" onclick="setFilter('tw')">å°ç£</button>
          <button id="f_jp" onclick="setFilter('jp')">æ—¥æœ¬</button>
        </div>
      </div>

      <input id="q" class="inp" style="margin-top:10px" placeholder="æœå°‹å•†å“ / é¡åˆ¥ / åº—å®¶ï¼ˆæ”¯æ´æ’åºï¼‰" oninput="renderList()" />
      <div class="small" style="margin:6px 2px 10px;">
        æœå°‹æ’åºï¼šå®Œå…¨ç›¸ç¬¦ ï¼ é–‹é ­ç›¸ç¬¦ ï¼ ä¸­æ®µç›¸ç¬¦ ï¼ é¡åˆ¥/åº—å®¶å‘½ä¸­ã€‚è³‡æ–™é‡ 50+ ä¹Ÿé©ç”¨ã€‚
      </div>

      <div id="listWrap" class="list"></div>
    </section>

    <!-- Settings -->
    <section id="settings" class="screen">
      <div class="title">è¨­å®š</div>

      <div class="card">
        <div style="font-weight:700;margin-bottom:6px;">è©¦ç®—è¡¨ç¶²å€æˆ– Sheet ID</div>
        <input id="sheetInput" class="inp" placeholder="è²¼ä¸Šæ•´å€‹ Google Sheets ç¶²å€ï¼Œæˆ–è²¼ Sheet IDï¼ˆé‚£ä¸²è‹±æ–‡æ•¸å­—ï¼‰" />
        <div class="small" style="margin-top:6px;">
          Sheet ID åœ¨ç¶²å€ä¸­ï¼š<br/>
          https://docs.google.com/spreadsheets/d/<b>é€™ä¸€ä¸²</b>/edit
        </div>
        <div class="row" style="margin-top:10px;">
          <button class="btn" onclick="saveSheetId()">å„²å­˜</button>
          <button class="btn secondary" onclick="loadFromSheets()">è¼‰å…¥è³‡æ–™</button>
        </div>
        <div class="small" id="loadStatus" style="margin-top:8px;"></div>
      </div>

      <div class="card">
        <div style="font-weight:700;margin-bottom:6px;">è‹¥è¼‰å…¥å¤±æ•—ï¼Œæœ€å¸¸è¦‹åŸå› </div>
        <div class="small">
          1) è©¦ç®—è¡¨æœªè¨­ç‚ºã€ŒçŸ¥é“é€£çµçš„äººå¯æª¢è¦–ã€ã€‚<br/>
          2) åˆ†é åç¨±ä¸æ˜¯ categories / stores / productsï¼ˆå¤§å°å¯«ä¸ç¬¦ä¹Ÿæœƒå¤±æ•—ï¼‰ã€‚<br/>
          3) æ¬„ä½è¡¨é ­æ‹¼å­—ä¸åŒï¼ˆéœ€èˆ‡ç¯„æœ¬ä¸€è‡´ï¼‰ã€‚
        </div>
      </div>

      <div class="card">
        <div style="font-weight:700;margin-bottom:6px;">å¿«å–</div>
        <div class="small">ç‚ºäº†é›¢ç·šä»å¯çœ‹è³‡æ–™ï¼ŒApp æœƒä¿ç•™ä¸Šæ¬¡æˆåŠŸè¼‰å…¥çš„å¿«å–ã€‚</div>
        <div class="row" style="margin-top:10px;">
          <button class="btn secondary" onclick="clearCache()">æ¸…é™¤å¿«å–</button>
        </div>
      </div>
    </section>
  
    <!-- Admin -->
    <section id="admin" class="screen">
      <div class="title">ç®¡ç†</div>
      <div class="card">
        <div style="font-weight:700;margin-bottom:6px;">é¡åˆ¥ç®¡ç†ï¼ˆåŒ¯ç‡ / ç¨…ç‡ï¼‰</div>
        <input id="cat_id" class="inp" placeholder="category_idï¼ˆå¦‚ drugstoreï¼‰" />
        <input id="cat_name" class="inp" placeholder="category_nameï¼ˆå¦‚ è—¥å¦é¡ï¼‰" />
        <input id="cat_fx" class="inp" placeholder="æ—¥å¹£åŒ¯ç‡ï¼ˆå¦‚ 0.2032ï¼‰" />
        <input id="cat_tax" class="inp" placeholder="æ—¥æœ¬ç¨…ç‡ï¼ˆå¦‚ 0.1ï¼‰" />

        <div class="row" style="margin-top:8px;">
          <div class="small" style="flex:1;">é¡åˆ¥é¡è‰²</div>
          <input id="cat_color" type="color" value="#6554f6" style="width:52px;height:40px;border:none;background:transparent;padding:0;" />
        </div>
        <div class="row" style="margin-top:6px;">
          <button class="btn secondary" type="button" onclick="setCatColor('#6554f6')">ç´«</button>
          <button class="btn secondary" type="button" onclick="setCatColor('#22c55e')">ç¶ </button>
          <button class="btn secondary" type="button" onclick="setCatColor('#f59e0b')">æ©˜</button>
          <button class="btn secondary" type="button" onclick="setCatColor('#ef4444')">ç´…</button>
          <button class="btn secondary" type="button" onclick="setCatColor('#0ea5e9')">è—</button>
          <button class="btn secondary" type="button" onclick="setCatColor('#8b5cf6')">ç´«2</button>
        </div>
        <div class="row" style="margin-top:10px;">
          <button class="btn" onclick="adminSaveCategory()">å„²å­˜</button>
        </div>
        <div class="small" id="adminMsg" style="margin-top:8px;"></div>
      </div>
    
      <div class="card">
        <div style="font-weight:700;margin-bottom:6px;">é¡åˆ¥é †åºï¼ˆå¯æ‹–æ›³ï¼‰</div>
        <div class="small" style="margin-bottom:8px;">
          ç”¨æ‰‹æŒ‡æŒ‰ä½å·¦é‚Šã€Œâ‰¡ã€æ‹–æ›³èª¿æ•´é †åºã€‚æŒ‰ã€Œå„²å­˜é †åºåˆ° Google Sheetsã€å¾Œï¼Œå…¶ä»–è£ç½®é‡æ–°è¼‰å…¥ä¹ŸæœƒåŒæ­¥ã€‚
        </div>
        <div id="catSortList" class="sortable"></div>
        <div class="row" style="margin-top:10px;">
          <button class="btn" onclick="saveCategoryOrderToSheet()">å„²å­˜é †åºåˆ° Google Sheets</button>
          <button class="btn secondary" onclick="resetCategoryOrderLocal()">é‡ç½®ç‚º Sheet é †åº</button>
        </div>
        <div class="small" id="catSortMsg" style="margin-top:8px;"></div>
        <div class="small" style="margin-top:8px;">
          æ³¨æ„ï¼šä½ çš„ categories åˆ†é éœ€æ–°å¢ä¸€æ¬„è¡¨é ­ <b>sort_order</b>ï¼Œæ‰æœƒæŠŠé †åºå¯«å›è©¦ç®—è¡¨ã€‚
        </div>
      </div>
</section>
</main>

    <button class="fab" id="fabAdd" onclick="openAddProduct()" title="æ–°å¢å•†å“">ï¼‹</button>
<nav class="nav">
    <div class="n active" id="nav_home" onclick="go('home')"><div class="i">ğŸ </div>é¦–é </div>
    <div class="n" id="nav_list" onclick="openList('all')"><div class="i">ğŸ“‹</div>å•†å“</div>
    <div class="n" id="nav_admin" onclick="go('admin')"><div class="i">ğŸ› ï¸</div>ç®¡ç†</div>
    <div class="n" id="nav_set" onclick="openSettings()"><div class="i">âš™ï¸</div>è¨­å®š</div>
  </nav>
</div>

<div id="bd" class="backdrop">
  <div class="sheet">
    <div class="handle"></div>
    <h3 id="d_title"></h3>
    <div class="sub" id="d_sub"></div>
    <div id="d_blocks"></div>
    <button class="btn" style="width:100%;margin-top:6px" onclick="closeDetail()">é—œé–‰</button>
  </div>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbyg0NTDkOmZkXFr2MsTlj3rOOgao202hU9gWb27SapaBFTdVLKoanR6OrL5ac7eIeiKZA/exec";
const API_TOKEN = "313703yiYI~";

async function apiPost(action, data){
  return new Promise((resolve, reject) => {
    const cb = "dc_cb_" + Math.random().toString(36).slice(2);

    window[cb] = (resp) => {
      try{
        if(!resp || resp.ok !== true) throw new Error(resp?.error || "API å¤±æ•—");
        resolve(resp);
      } catch(e){
        reject(e);
      } finally {
        try{ delete window[cb]; } catch(_){}
        script.remove();
      }
    };

    const url =
      API_URL +
      "?action=" + encodeURIComponent(action) +
      "&token=" + encodeURIComponent(API_TOKEN) +
      "&callback=" + encodeURIComponent(cb) +
      "&data=" + encodeURIComponent(JSON.stringify(data || {}));

    const script = document.createElement("script");
    script.src = url;
    script.onerror = () => {
      reject(new Error("JSONP è¼‰å…¥å¤±æ•—ï¼ˆå¯èƒ½æ˜¯éƒ¨ç½²/æ¬Šé™/token å•é¡Œï¼‰"));
      try{ delete window[cb]; } catch(_){}
      script.remove();
    };

    document.body.appendChild(script);
  });
}

  // -------------------- Category & Product overrides --------------------
  // Category-level overrides (per device)
  const KEY_OVERRIDES = "dc_overrides_v1";
  let overrides = {};
  try{ overrides = JSON.parse(localStorage.getItem(KEY_OVERRIDES) || "{}") || {}; }catch(e){ overrides = {}; }

  // Product-level overrides (per device)
  // key: product_id -> { fx, taxRate }
  const KEY_PROD_OVERRIDES = "dc_prod_overrides_v1";
  let prodOverrides = {};
  try{ prodOverrides = JSON.parse(localStorage.getItem(KEY_PROD_OVERRIDES) || "{}") || {}; }catch(e){ prodOverrides = {}; }

  function setOverrideRates(category_id, fx, taxRate){
    if(!category_id) return;
    if(!overrides[category_id]) overrides[category_id] = {};
    if(typeof fx === "number" && !isNaN(fx)) overrides[category_id].fx = fx;
    if(typeof taxRate === "number" && !isNaN(taxRate)) overrides[category_id].taxRate = taxRate;
    localStorage.setItem(KEY_OVERRIDES, JSON.stringify(overrides));
  }

  function setProductOverrideRates(product_id, fx, taxRate){
    if(!product_id) return;
    if(!prodOverrides[product_id]) prodOverrides[product_id] = {};
    if(typeof fx === "number" && !isNaN(fx)) prodOverrides[product_id].fx = fx;
    if(typeof taxRate === "number" && !isNaN(taxRate)) prodOverrides[product_id].taxRate = taxRate;
    localStorage.setItem(KEY_PROD_OVERRIDES, JSON.stringify(prodOverrides));
  }

  function clearProductOverrideRates(product_id){
    if(!product_id) return;
    if(prodOverrides[product_id]) delete prodOverrides[product_id];
    localStorage.setItem(KEY_PROD_OVERRIDES, JSON.stringify(prodOverrides));
  }

  function getEffectiveFx(p){
    // product override > category override > sheet
    const pov = p && p.id && prodOverrides[p.id] ? prodOverrides[p.id] : null;
    if(pov && typeof pov.fx === "number") return pov.fx;

    const cid = p.category_id;
    const ov = cid && overrides[cid] ? overrides[cid] : null;
    return (ov && typeof ov.fx === "number") ? ov.fx : (p.fx || 0.2032);
  }
  function getEffectiveTax(p){
    const pov = p && p.id && prodOverrides[p.id] ? prodOverrides[p.id] : null;
    if(pov && typeof pov.taxRate === "number") return pov.taxRate;

    const cid = p.category_id;
    const ov = cid && overrides[cid] ? overrides[cid] : null;
    return (ov && typeof ov.taxRate === "number") ? ov.taxRate : (p.taxRate ?? 0.10);
  }

  function defaultColorForCategory(category_id){
    // deterministic pastel palette based on id
    const palette = ["#6554f6","#22c55e","#f59e0b","#ef4444","#06b6d4","#a855f7","#84cc16","#fb7185","#0ea5e9","#f97316"];
    let h = 0;
    const s = String(category_id||"");
    for(let i=0;i<s.length;i++){ h = (h*31 + s.charCodeAt(i)) >>> 0; }
    return palette[h % palette.length];
  }

// -------------------- Storage keys --------------------

  const KEY_SHEET = "dc_sheet_id_or_url_v1";
  const KEY_CACHE = "dc_cache_v1";

  // -------------------- State --------------------
  let filter = "all";
  let categoriesById = {};
  let stores = [];                // raw rows
  let storesByKey = {};           // key: country|category_id -> list
  let products = [];              // aggregated products for UI
  let currentDetailProduct = null; // for detail actions

  // -------------------- Utilities --------------------
  function show(id){
    document.querySelectorAll(".screen").forEach(s=>s.classList.remove("active"));
    const el = document.getElementById(id);
    if(el) el.classList.add("active");

    const navHome = document.getElementById("nav_home");
    const navList = document.getElementById("nav_list");
    const navAdmin = document.getElementById("nav_admin");
    const navSet  = document.getElementById("nav_set");

    if(navHome) navHome.classList.toggle("active", id==="home");
    if(navList) navList.classList.toggle("active", id==="list");
    if(navAdmin) navAdmin.classList.toggle("active", id==="admin");
    if(navSet)  navSet.classList.toggle("active", id==="settings");

    if(id==="admin"){ try{ renderCategorySortUI(); }catch(_){} }

    // FAB only on list screen
    const fab = document.getElementById("fabAdd");
    if(fab) fab.style.display = (id==="list") ? "block" : "none";
  }
  
function go(id){ show(id); }
  function openSettings(){ show("settings"); }
  function openList(f){ filter=f||"all"; show("list"); setFilter(filter); renderList(); }
  function setFilter(f){
    filter=f;
    ["all","tw","jp"].forEach(k=>{
      document.getElementById("f_"+k).classList.toggle("active", k===filter);
    });
    renderList();
  }
  function closeDetail(){ document.getElementById("bd").classList.remove("active"); }
  document.getElementById("bd").addEventListener("click", (e)=>{ if(e.target.id==="bd") closeDetail(); });

  function extractSheetId(input){
    const t = (input||"").trim();
    if(!t) return "";
    // If full URL
    const m = t.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
    if(m && m[1]) return m[1];
    // maybe already ID
    return t;
  }

  // Robust CSV parse (handles quotes)
  function parseCsv(text){
    // remove BOM
    if(text.charCodeAt(0) === 0xFEFF) text = text.slice(1);
    const rows = [];
    let row = [];
    let cur = "";
    let inQ = false;
    for(let i=0;i<text.length;i++){
      const ch = text[i];
      const next = text[i+1];

      if(ch === '"'){
        if(inQ && next === '"'){ cur+='"'; i++; }
        else inQ = !inQ;
      } else if(ch === ',' && !inQ){
        row.push(cur); cur="";
      } else if((ch === '\n' || ch === '\r') && !inQ){
        if(ch === '\r' && next === '\n') i++;
        row.push(cur); cur="";
        // skip empty last lines
        const allEmpty = row.every(c => (c||"").trim()==="");
        if(!allEmpty) rows.push(row);
        row = [];
      } else {
        cur += ch;
      }
    }
    row.push(cur);
    const allEmpty = row.every(c => (c||"").trim()==="");
    if(!allEmpty) rows.push(row);
    return rows;
  }

  function rowsToObjects(rows){
    if(!rows.length) return [];
    const header = rows[0].map(h => (h||"").trim());
    const out = [];
    for(let i=1;i<rows.length;i++){
      const r = rows[i];
      const obj = {};
      header.forEach((h,idx)=> obj[h] = (r[idx] ?? "").trim());
      out.push(obj);
    }
    return out;
  }

  function numOrNull(v){
    const n = parseFloat(v);
    return isNaN(n) ? null : n;
  }

  // -------------------- Google Sheets fetch via gviz CSV --------------------
  async function fetchSheetCsv(sheetId, sheetName){
    const url = `https://docs.google.com/spreadsheets/d/${encodeURIComponent(sheetId)}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(sheetName)}`;
    const res = await fetch(url, { cache: "no-store" });
    if(!res.ok) throw new Error(`è®€å– ${sheetName} å¤±æ•—ï¼ˆHTTP ${res.status}ï¼‰`);
    return await res.text();
  }

  async function loadFromSheets(){
    const status = document.getElementById("loadStatus");
    status.textContent = "è¼‰å…¥ä¸­â€¦";
    try{
      const raw = localStorage.getItem(KEY_SHEET) || "";
      const sheetId = extractSheetId(raw);
      if(!sheetId) { status.textContent = "è«‹å…ˆå„²å­˜è©¦ç®—è¡¨ç¶²å€æˆ– Sheet IDã€‚"; return; }

      // Fetch 3 sheets
      const [csvCat, csvStores, csvProd] = await Promise.all([
        fetchSheetCsv(sheetId, "categories"),
        fetchSheetCsv(sheetId, "stores"),
        fetchSheetCsv(sheetId, "products"),
      ]);

      const cats = rowsToObjects(parseCsv(csvCat));
      const st   = rowsToObjects(parseCsv(csvStores));
      const pr   = rowsToObjects(parseCsv(csvProd));

      // Validate minimal headers
      // categories: category_id, category_name, jpy_to_twd, jp_tax_rate
      // stores: store_id, store_name, country, category_id
      // products: product_id, name, spec, category_id, store_id, price_twd, price_jpy_untaxed, price_jpy_tax
      buildDataModel(cats, st, pr);

      // Cache
      localStorage.setItem(KEY_CACHE, JSON.stringify({ cats, st, pr, at: Date.now() }));

      status.textContent = "è¼‰å…¥æˆåŠŸã€‚";
      updateSourceInfo();
      renderList();
      show("list");
    }catch(err){
      console.error(err);
      status.textContent = "è¼‰å…¥å¤±æ•—ï¼š" + err.message + "ã€‚å¯æª¢æŸ¥å…±äº«æ¬Šé™ã€åˆ†é åç¨±ã€è¡¨é ­æ¬„ä½ã€‚";
      // Try fallback cache
      const cache = localStorage.getItem(KEY_CACHE);
      if(cache){
        try{
          const data = JSON.parse(cache);
          buildDataModel(data.cats||[], data.st||[], data.pr||[]);
          status.textContent += "ï¼ˆå·²æ”¹ç”¨ä¸Šæ¬¡å¿«å–è³‡æ–™é¡¯ç¤ºï¼‰";
          updateSourceInfo(true);
          renderList();
        }catch(e){}
      }
    }
  }

  function clearCache(){
    localStorage.removeItem(KEY_CACHE);
    alert("å·²æ¸…é™¤å¿«å–ã€‚");
  }

  function buildDataModel(cats, st, pr){
    // categories
    categoriesById = {};
    cats.forEach(c=>{
      const id = c.category_id;
      if(!id) return;
      categoriesById[id] = {
        id,
        name: c.category_name || id,
        jpy_to_twd: numOrNull(c.jpy_to_twd) ?? 0.2032,
        jp_tax_rate: numOrNull(c.jp_tax_rate) ?? 0.10,
        color: (c.color && String(c.color).trim()) ? String(c.color).trim() : defaultColorForCategory(id)
      };
    });

    // stores registry
    stores = st.map(r=>({
      store_id: r.store_id,
      store_name: r.store_name || r.store_id,
      country: (r.country||"").toUpperCase(),
      category_id: r.category_id
    })).filter(x=>x.store_id && x.country && x.category_id);

    storesByKey = {};
    stores.forEach(s=>{
      const key = `${s.country}|${s.category_id}`;
      if(!storesByKey[key]) storesByKey[key]=[];
      storesByKey[key].push(s);
    });

    // products rows -> aggregate by product_id
    const byPid = {};
    pr.forEach(r=>{
      const pid = r.product_id;
      if(!pid) return;
      if(!byPid[pid]){
        byPid[pid] = {
          id: pid,
          name: r.name || "",
          spec: r.spec || "",
          category_id: r.category_id || "",
          photo: r.photo || "",   // optional (if later you add)
          twPricesByStore: {},    // store_id -> {priceTwd, note?}
          jpPricesByStore: {},    // store_id -> {untaxed, tax}
        };
      }
      // keep latest name/spec/category if provided
      if(r.name) byPid[pid].name = r.name;
      if(r.spec) byPid[pid].spec = r.spec;
      if(r.category_id) byPid[pid].category_id = r.category_id;

      const storeId = r.store_id;
      if(!storeId) return;

      const pTwd = numOrNull(r.price_twd);
      const pJu  = numOrNull(r.price_jpy_untaxed);
      const pJt  = numOrNull(r.price_jpy_tax);

      // Determine country by store registry if possible
      const store = stores.find(s=>s.store_id===storeId);
      const country = store ? store.country : "";

      if(country==="TW" && pTwd!=null){
        byPid[pid].twPricesByStore[storeId] = { priceTwd: pTwd };
      }
      if(country==="JP" && (pJu!=null || pJt!=null)){
        byPid[pid].jpPricesByStore[storeId] = { untaxed: pJu, tax: pJt };
      }
    });

    // build UI products with full store list display logic
    products = Object.values(byPid).map(p=>{
      const cat = categoriesById[p.category_id] || {name:p.category_id||"æœªåˆ†é¡", jpy_to_twd:0.2032, jp_tax_rate:0.10, color: defaultColorForCategory(p.category_id)};
      const twList = (storesByKey[`TW|${p.category_id}`] || []).map(s=>{
        const price = p.twPricesByStore[s.store_id]?.priceTwd ?? null;
        return { name: s.store_name, store_id: s.store_id, priceTwd: price };
      });
      const jpList = (storesByKey[`JP|${p.category_id}`] || []).map(s=>{
        const it = p.jpPricesByStore[s.store_id] || {};
        let untaxed = (it.untaxed==null? null : it.untaxed);
        let tax = (it.tax==null? null : it.tax);

        // If only untaxed exists, compute tax by category rate
        if(untaxed!=null && tax==null){
          tax = Math.round(untaxed * (1 + (cat.jp_tax_rate ?? 0.10)));
        }
        return { name: s.store_name, store_id: s.store_id, untaxed, tax };
      });

      const prodOv = getProdOverride_(p.id);
      const catOv = getCatOverride_(p.category_id);
      const effFx = (prodOv && prodOv.fx) ? Number(prodOv.fx) : (catOv && catOv.fx) ? Number(catOv.fx) : (cat.jpy_to_twd);
      const effTax = (prodOv && prodOv.tax) ? Number(prodOv.tax) : (catOv && catOv.tax) ? Number(catOv.tax) : (cat.jp_tax_rate);
      return {
        id: p.id,
        name: p.name,
        spec: p.spec,
        category_id: p.category_id,
        category_name: cat.name,
        category_color: cat.color || defaultColorForCategory(p.category_id),
        fx: effFx,
        taxRate: effTax,
        photo: p.photo || "",
        twStores: twList,
        jpStores: jpList
      };
    });
  }

  // -------------------- Search ranking --------------------
  function scoreMatch(text, q){
    if(!q) return 9999;
    text = (text||"").toLowerCase();
    q = q.toLowerCase();
    if(text === q) return 0;              // perfect
    if(text.startsWith(q)) return 1;      // prefix
    const idx = text.indexOf(q);
    if(idx >= 0) return 10 + idx;         // contains earlier = better
    return 999999;
  }

  
function renderList(){
  const wrap = document.getElementById("listWrap");
  const qRaw = (document.getElementById("q")?.value||"").trim();
  const q = qRaw.toLowerCase();
  wrap.innerHTML = "";

  // 1) filter by TW/JP availability
  const filtered = products.filter(p=>{
    const hasTW = p.twStores.some(s=>s.priceTwd!=null);
    const hasJP = p.jpStores.some(s=>s.untaxed!=null || s.tax!=null);
    if(filter==="tw" && !hasTW) return false;
    if(filter==="jp" && !hasJP) return false;
    return true;
  });

  // 2) apply search filter
  const searched = filtered.filter(p=>{
    if(!q) return true;
    const hay = [
      p.name||"",
      p.spec||"",
      p.category_name||"",
      ...p.twStores.map(s=>s.name||""),
      ...p.jpStores.map(s=>s.name||"")
    ].join(" ").toLowerCase();
    return hay.includes(q);
  });

  // 3) group by category_id
  const groups = new Map();
  for(const p of searched){
    const cid = p.category_id || "uncat";
    const cobj = categoriesById[cid] || {};
    if(!groups.has(cid)) groups.set(cid, { 
      cid,
      cname: p.category_name || cobj.name || "æœªåˆ†é¡",
      color: cobj.color || p.category_color || "#6554f6",
      items: []
    });
    groups.get(cid).items.push(p);
  }

  // 4) order categories by name
  const orderedCats = Array.from(groups.values()).sort((a,b)=>{
    return String(a.cname).localeCompare(String(b.cname), "zh-Hant") 
      || String(a.cid).localeCompare(String(b.cid));
  });

  // 5) within category: name length asc, then name
  for(const g of orderedCats){
    g.items.sort((a,b)=>{
      return compareNamesAdvanced(a.name, b.name)
        || String(a.id||"").localeCompare(String(b.id||""));
    });
  }

  if(!orderedCats.length){
    const e = document.createElement("div");
    e.className="small";
    e.style.margin="10px 2px";
    e.textContent = q ? "æ‰¾ä¸åˆ°ç¬¦åˆçš„å•†å“" : "ç›®å‰æ²’æœ‰è³‡æ–™ï¼ˆè«‹åˆ°è¨­å®šè¼‰å…¥ Google Sheetsï¼‰";
    wrap.appendChild(e);
    return;
  }

  for(const g of orderedCats){
    const card = document.createElement("div");
    card.className = "catCard";
    card.style.background = hexToRgba(g.color, 0.12);
    card.style.border = `1px solid ${hexToRgba(g.color, 0.25)}`;
    const inner = document.createElement("div");
    inner.className = "catCardInner";
    const h = document.createElement("div");
    h.className = "catHeader";
    h.innerHTML = `<span class="catDot" style="background:${escapeHtml(g.color)}"></span>                   <span>${escapeHtml(g.cname)}</span>                   <span class="small">${g.items.length} é …</span>`;
    inner.appendChild(h);
    card.appendChild(inner);
    wrap.appendChild(card);

g.items.forEach(p=>{
      const hasTW = p.twStores.some(s=>s.priceTwd!=null);
      const hasJP = p.jpStores.some(s=>s.untaxed!=null || s.tax!=null);
      let tag = hasTW && hasJP ? "å°ç£ + æ—¥æœ¬" : hasTW ? "å°ç£" : "æ—¥æœ¬";

      const twMin = hasTW ? Math.min(...p.twStores.filter(s=>s.priceTwd!=null).map(s=>s.priceTwd)) : null;
      const jpVals = p.jpStores.flatMap(s=>[s.untaxed,s.tax]).filter(v=>typeof v==="number");
      const jpMin = jpVals.length ? Math.min(...jpVals) : null;

      const fx = p.fx || 0.2032;
      const jpMinTwd = jpMin!=null ? Math.round(jpMin * fx) : null;

      const item = document.createElement("div");
      item.className = "item";
      item.onclick = ()=>openDetail(p);

      const th = document.createElement("div");
      th.className = "thumb";
      if(p.photo){
        const img=document.createElement("img");
        img.src=p.photo;
        th.appendChild(img);
      } else th.textContent="Photo";

      const mid = document.createElement("div");
      mid.style.flex="1";

      const nm = document.createElement("div");
      nm.className="name";
      nm.textContent=p.name;

      const sp = document.createElement("div");
      sp.className="spec";
      sp.innerHTML = `${escapeHtml(p.spec || "")}  Â·  <span class="tag" style="background:${escapeHtml(g.color)};color:#fff">${escapeHtml(g.cname)}</span>`;

      const meta = document.createElement("div");
      meta.className="meta";
      meta.innerHTML = `<div class="small">${hasTW?`å°ç£åº—:${p.twStores.length}`:"å°ç£åº—:0"} Â· ${hasJP?`æ—¥æœ¬åº—:${p.jpStores.length}`:"æ—¥æœ¬åº—:0"}</div>
                        <div class="tag">${tag}</div>`;

      const sum = document.createElement("div");
      sum.className="sum";
      if(hasTW && !hasJP){
        sum.innerHTML = `<strong>å°ç£æœ€ä½ NT$ ${twMin ?? "-"}</strong>`;
      } else if(!hasTW && hasJP){
        sum.innerHTML = `<strong>æ—¥æœ¬ç´„ NT$ ${jpMinTwd ?? "-"}</strong>ï¼ˆåŒ¯ç‡ ${fx}ï¼‰`;
      } else if(hasTW && hasJP){
        sum.innerHTML = `<strong>å°ç£ NT$ ${twMin ?? "-"} / æ—¥æœ¬ç´„ NT$ ${jpMinTwd ?? "-"}</strong>ï¼ˆåŒ¯ç‡ ${fx}ï¼‰`;
      } else {
        sum.textContent = "å°šæœªè¼¸å…¥åƒ¹æ ¼";
      }

      mid.appendChild(nm);
      mid.appendChild(sp);
      mid.appendChild(meta);
      mid.appendChild(sum);

      item.appendChild(th);
      item.appendChild(mid);
      inner.appendChild(item);
    });
  }
}


function openDetail(p){
  document.getElementById("d_title").textContent = p.name;
  document.getElementById("d_sub").textContent = `${p.spec || ""} Â· ${p.category_name || ""} Â·ï¼ˆå¯ç›´æ¥è¼¸å…¥åƒ¹æ ¼ï¼‰`;

  const blocks = document.getElementById("d_blocks");
  blocks.innerHTML = "";

  // Rates override UI
  const rateBox = document.createElement("div");
  rateBox.className = "block";
  rateBox.innerHTML = `
    <div class="bt">åŒ¯ç‡ / ç¨…ç‡ï¼ˆå¯è‡ªè¡Œè¼¸å…¥ï¼‰</div>
    <div class="small" style="margin-bottom:6px;">å¯ã€Œåªå¥—ç”¨åˆ°æ­¤å•†å“ï¼ˆæœ¬æ©Ÿï¼‰ã€æˆ–ã€Œå¯«å›é¡åˆ¥ï¼ˆSheets åŒæ­¥ï¼‰ã€</div>
    <div style="display:grid;gap:8px;">
      <input id="rt_fx" class="inp" type="number" inputmode="decimal" step="0.0001" placeholder="åŒ¯ç‡ï¼š1 JPY â‰ˆ ? NTDï¼ˆä¾‹å¦‚ 0.2032ï¼‰" value="${escapeHtml(p.fx ?? "")}"/>
      <input id="rt_tax" class="inp" type="number" inputmode="decimal" step="0.001" placeholder="ç¨…ç‡ï¼šä¾‹å¦‚ 0.1ï¼ˆ10%ï¼‰" value="${escapeHtml(p.taxRate ?? "")}"/>
      <div class="row">
        <button class="btn secondary" onclick="applyRateToProduct('${escapeHtml(p.id)}')">å¥—ç”¨åˆ°æ­¤å•†å“ï¼ˆæœ¬æ©Ÿï¼‰</button>
        <button class="btn secondary" onclick="applyRateToCategoryLocal('${escapeHtml(p.category_id)}')">å¥—ç”¨åˆ°æ­¤é¡åˆ¥ï¼ˆæœ¬æ©Ÿï¼‰</button>
      </div>
      <div class="row">
        <button class="btn" onclick="saveRateToCategorySheet('${escapeHtml(p.category_id)}')">å„²å­˜åˆ°é¡åˆ¥ï¼ˆå¯«å› Sheetsï¼‰</button>
        <button class="btn secondary" onclick="clearProductOverride('${escapeHtml(p.id)}')">æ¸…é™¤æ­¤å•†å“è¦†å¯«</button>
      </div>
      <div class="small" id="rt_msg"></div>
    </div>
  `;
  blocks.appendChild(rateBox);

  // Taiwan stores editable
  const b1 = document.createElement("div");
  b1.className="block";
  b1.innerHTML = `<div class="bt">å°ç£ï¼ˆ${p.twStores.length} å®¶ï¼‰</div>`;
  p.twStores.forEach(s=>{
    const row = document.createElement("div");
    row.className="sr";
    row.innerHTML = `
      <div><div class="sn">${escapeHtml(s.name)}</div><div class="note">${s.priceTwd==null?"å°šæœªå¡«åƒ¹":""}</div></div>
      <div style="min-width:170px">
        <input class="inp dc_price_twd" type="number" inputmode="numeric" step="1"
          data-store-id="${escapeHtml(s.store_id)}" placeholder="NT$"
          value="${s.priceTwd==null?"":escapeHtml(s.priceTwd)}"/>
      </div>`;
    b1.appendChild(row);
  });
  blocks.appendChild(b1);

  // Japan stores editable
  const b2 = document.createElement("div");
  b2.className="block";
  b2.innerHTML = `<div class="bt">æ—¥æœ¬ï¼ˆ${p.jpStores.length} å®¶ï¼‰</div>`;
  p.jpStores.forEach(s=>{
    const row = document.createElement("div");
    row.className="sr";
    row.innerHTML = `
      <div><div class="sn">${escapeHtml(s.name)}</div><div class="note">${(s.untaxed==null && s.tax==null)?"å°šæœªå¡«åƒ¹":""}</div></div>
      <div style="min-width:190px;display:grid;gap:6px">
        <input class="inp dc_price_jpu" type="number" inputmode="numeric" step="1"
          data-store-id="${escapeHtml(s.store_id)}" placeholder="æœªç¨… Â¥"
          value="${s.untaxed==null?"":escapeHtml(s.untaxed)}"/>
        <input class="inp dc_price_jpt" type="number" inputmode="numeric" step="1"
          data-store-id="${escapeHtml(s.store_id)}" placeholder="å«ç¨… Â¥"
          value="${s.tax==null?"":escapeHtml(s.tax)}"/>
      </div>`;
    b2.appendChild(row);
  });
  blocks.appendChild(b2);

  const saveBtn = document.createElement("button");
  saveBtn.className = "btn";
  saveBtn.style.width = "100%";
  saveBtn.style.marginTop = "6px";
  saveBtn.textContent = "å„²å­˜æ­¤å•†å“åƒ¹æ ¼ï¼ˆå¯«å› Sheetsï¼‰";
  saveBtn.onclick = ()=>savePricesForProduct(p);
  blocks.appendChild(saveBtn);

  const msg = document.createElement("div");
  msg.className = "small";
  msg.id = "price_msg";
  msg.style.marginTop = "8px";
  blocks.appendChild(msg);

  document.getElementById("bd").classList.add("active");
  setupAutoJpCalc_(p);
}

// -------------------- JP price auto-calc (tax-in <-> untaxed) --------------------
function normalizeTaxRate_(v){
  // Accept 0.1 (10%) or 10 (10%). Clamp to sane range.
  let n = parseFloat(v);
  if(isNaN(n)) return NaN;
  if(n > 1.5) n = n / 100; // treat as percent
  if(n < 0) n = 0;
  if(n > 1) n = 1;
  return n;
}
function getCurrentTaxRateForDetail_(p){
  // Prefer the override input in detail sheet; fallback to product/category default
  const el = document.getElementById("rt_tax");
  const vRaw = el ? el.value : "";
  const v = normalizeTaxRate_(vRaw);
  if(!isNaN(v)) return v;

  const base = (p && (p.taxRate != null)) ? p.taxRate : 0.10;
  const baseN = normalizeTaxRate_(base);
  return isNaN(baseN) ? 0.10 : baseN;
}
function calcUntaxedFromTax_(taxIncl, taxRate){
  const t = Number(taxIncl);
  if(!isFinite(t)) return null;
  const r = (1 + (taxRate || 0));
  if(!isFinite(r) || r <= 0) return null;
  return Math.round(t / r);
}
function calcTaxFromUntaxed_(untaxed, taxRate){
  const u = Number(untaxed);
  if(!isFinite(u)) return null;
  const r = (1 + (taxRate || 0));
  if(!isFinite(r) || r <= 0) return null;
  return Math.round(u * r);
}
function setupAutoJpCalc_(p){
  // Goal:
  // - When user types TAX-IN, update UNTAXED live (not only when empty)
  // - When user types UNTAXED, update TAX-IN live
  // - Avoid infinite loops (guard)
  // - If user last edited one side, we treat that as the source of truth
  const guard = new Set();               // per store_id guard
  const lastEdited = new Map();          // store_id -> "tax" | "untaxed"

  const getPair = (storeId) => {
    const jpu = document.querySelector(`.dc_price_jpu[data-store-id="${cssEscape_(storeId)}"]`);
    const jpt = document.querySelector(`.dc_price_jpt[data-store-id="${cssEscape_(storeId)}"]`);
    return { jpu, jpt };
  };

  const updateFromTax = (storeId) => {
    if(guard.has(storeId)) return;
    const { jpu, jpt } = getPair(storeId);
    if(!jpu || !jpt) return;

    const taxVal = (jpt.value || "").trim();
    if(taxVal === "") return;

    const taxRate = getCurrentTaxRateForDetail_(p);
    const u = calcUntaxedFromTax_(taxVal, taxRate);
    if(u == null) return;

    guard.add(storeId);
    jpu.value = String(u);
    guard.delete(storeId);
  };

  const updateFromUntaxed = (storeId) => {
    if(guard.has(storeId)) return;
    const { jpu, jpt } = getPair(storeId);
    if(!jpu || !jpt) return;

    const untVal = (jpu.value || "").trim();
    if(untVal === "") return;

    const taxRate = getCurrentTaxRateForDetail_(p);
    const t = calcTaxFromUntaxed_(untVal, taxRate);
    if(t == null) return;

    guard.add(storeId);
    jpt.value = String(t);
    guard.delete(storeId);
  };

  const bindOne = (storeId) => {
    const { jpu, jpt } = getPair(storeId);
    if(!jpu || !jpt) return;

    jpt.addEventListener("input", () => {
      if(guard.has(storeId)) return;
      lastEdited.set(storeId, "tax");
      updateFromTax(storeId);
    });

    jpu.addEventListener("input", () => {
      if(guard.has(storeId)) return;
      lastEdited.set(storeId, "untaxed");
      updateFromUntaxed(storeId);
    });

    // Initial fill:
    // - If only one side exists, compute the other.
    // - If both exist, do nothing.
    const taxVal = (jpt.value || "").trim();
    const untVal = (jpu.value || "").trim();
    if(taxVal !== "" && untVal === "") updateFromTax(storeId);
    if(untVal !== "" && taxVal === "") updateFromUntaxed(storeId);
  };

  // Bind all JP rows currently shown
  const jpInputs = Array.from(document.querySelectorAll(".dc_price_jpt[data-store-id]"));
  jpInputs.forEach(inp => bindOne((inp.getAttribute("data-store-id") || "").trim()));

  // When tax rate changes, recompute counterpart based on the last-edited side
  const taxEl = document.getElementById("rt_tax");
  if(taxEl){
    taxEl.addEventListener("input", () => {
      jpInputs.forEach(inp => {
        const storeId = (inp.getAttribute("data-store-id") || "").trim();
        const { jpu, jpt } = getPair(storeId);
        if(!jpu || !jpt) return;

        const mode = lastEdited.get(storeId); // may be undefined
        const taxVal = (jpt.value || "").trim();
        const untVal = (jpu.value || "").trim();

        // If user has started editing one side, keep that as source of truth.
        if(mode === "tax" && taxVal !== "") updateFromTax(storeId);
        else if(mode === "untaxed" && untVal !== "") updateFromUntaxed(storeId);
        else {
          // no preference yet: only fill missing side
          if(taxVal !== "" && untVal === "") updateFromTax(storeId);
          if(untVal !== "" && taxVal === "") updateFromUntaxed(storeId);
        }
      });

      try{ renderList(); }catch(_){}
    });
  }
}

function cssEscape_(s){
  // Use in CSS attribute selectors; escape quotes and backslashes
  return String(s || "").replace(/["\\]/g, "\\$&");
}
function setMsg(id, text, isError){
  const el = document.getElementById(id);
  if(!el) return;
  el.textContent = text || "";
  el.style.color = isError ? "#b91c1c" : "";
}
function applyRateToProduct(pid){
  const fx = parseFloat(document.getElementById("rt_fx").value);
  const tax = parseFloat(document.getElementById("rt_tax").value);
  if(isNaN(fx) || fx<=0){ setMsg("rt_msg","åŒ¯ç‡è«‹è¼¸å…¥æ­£ç¢ºæ•¸å­—ï¼ˆä¾‹å¦‚ 0.2032ï¼‰", true); return; }
  if(isNaN(tax) || tax<0){ setMsg("rt_msg","ç¨…ç‡è«‹è¼¸å…¥æ­£ç¢ºæ•¸å­—ï¼ˆä¾‹å¦‚ 0.1ï¼‰", true); return; }
  localStorage.setItem("dc_prod_override_v1_" + pid, JSON.stringify({ fx, tax, at: Date.now() }));
  setMsg("rt_msg","å·²å¥—ç”¨åˆ°æ­¤å•†å“ï¼ˆæœ¬æ©Ÿï¼‰ã€‚", false);
  try{ renderList(); }catch(_){}
}
function applyRateToCategoryLocal(cid){
  const fx = parseFloat(document.getElementById("rt_fx").value);
  const tax = parseFloat(document.getElementById("rt_tax").value);
  if(isNaN(fx) || fx<=0){ setMsg("rt_msg","åŒ¯ç‡è«‹è¼¸å…¥æ­£ç¢ºæ•¸å­—ï¼ˆä¾‹å¦‚ 0.2032ï¼‰", true); return; }
  if(isNaN(tax) || tax<0){ setMsg("rt_msg","ç¨…ç‡è«‹è¼¸å…¥æ­£ç¢ºæ•¸å­—ï¼ˆä¾‹å¦‚ 0.1ï¼‰", true); return; }
  localStorage.setItem("dc_cat_override_v1_" + cid, JSON.stringify({ fx, tax, at: Date.now() }));
  setMsg("rt_msg","å·²å¥—ç”¨åˆ°æ­¤é¡åˆ¥ï¼ˆæœ¬æ©Ÿï¼‰ã€‚", false);
  try{ renderList(); }catch(_){}
}
async function saveRateToCategorySheet(cid){
  const fx = parseFloat(document.getElementById("rt_fx").value);
  const tax = parseFloat(document.getElementById("rt_tax").value);
  if(isNaN(fx) || fx<=0){ setMsg("rt_msg","åŒ¯ç‡è«‹è¼¸å…¥æ­£ç¢ºæ•¸å­—ï¼ˆä¾‹å¦‚ 0.2032ï¼‰", true); return; }
  if(isNaN(tax) || tax<0){ setMsg("rt_msg","ç¨…ç‡è«‹è¼¸å…¥æ­£ç¢ºæ•¸å­—ï¼ˆä¾‹å¦‚ 0.1ï¼‰", true); return; }

  const c = categoriesById[cid] || { id: cid, name: cid, color:"#6554f6" };
  const payload = { category_id: cid, category_name: c.name || cid, jpy_to_twd: fx, jp_tax_rate: tax, color: c.color || "#6554f6" };
  try{
    setMsg("rt_msg","å„²å­˜ä¸­â€¦", false);
    await apiPost("upsertCategory", payload);
    localStorage.setItem("dc_cat_override_v1_" + cid, JSON.stringify({ fx, tax, at: Date.now() }));
    setMsg("rt_msg","å·²å¯«å› Sheetsã€‚å…¶ä»–è¨­å‚™é‡æ–°è¼‰å…¥å¾ŒæœƒåŒæ­¥ã€‚", false);
    await loadFromSheets();
  }catch(err){
    setMsg("rt_msg","å„²å­˜å¤±æ•—ï¼š" + (err.message||err), true);
  }
}
function clearProductOverride(pid){
  localStorage.removeItem("dc_prod_override_v1_" + pid);
  setMsg("rt_msg","å·²æ¸…é™¤æ­¤å•†å“è¦†å¯«ã€‚", false);
  try{ renderList(); }catch(_){}
}

async function savePricesForProduct(p){
  setMsg("price_msg","",false);

  // store_id -> { price_twd?, price_jpy_untaxed?, price_jpy_tax? }
  const byStore = new Map();

  // å°ç£åƒ¹æ ¼ï¼ˆåªåœ¨æœ‰è¼¸å…¥æ™‚æ‰å¯«å…¥ï¼‰
  for(const inp of Array.from(document.querySelectorAll(".dc_price_twd"))){
    const store_id = (inp.getAttribute("data-store-id") || "").trim();
    const v = (inp.value || "").trim();
    if(!store_id) continue;

    if(!byStore.has(store_id)) byStore.set(store_id, {});
    if(v !== "") byStore.get(store_id).price_twd = Number(v); // âœ… ç©ºç™½ä¸é€å‡º
  }

  // æ—¥æœ¬æœªç¨…ï¼ˆåªåœ¨æœ‰è¼¸å…¥æ™‚æ‰å¯«å…¥ï¼‰
  for(const inp of Array.from(document.querySelectorAll(".dc_price_jpu"))){
    const store_id = (inp.getAttribute("data-store-id") || "").trim();
    const v = (inp.value || "").trim();
    if(!store_id) continue;

    if(!byStore.has(store_id)) byStore.set(store_id, {});
    if(v !== "") byStore.get(store_id).price_jpy_untaxed = Number(v); // âœ… ç©ºç™½ä¸é€å‡º
  }

  // æ—¥æœ¬å«ç¨…ï¼ˆåªåœ¨æœ‰è¼¸å…¥æ™‚æ‰å¯«å…¥ï¼‰
  for(const inp of Array.from(document.querySelectorAll(".dc_price_jpt"))){
    const store_id = (inp.getAttribute("data-store-id") || "").trim();
    const v = (inp.value || "").trim();
    if(!store_id) continue;

    if(!byStore.has(store_id)) byStore.set(store_id, {});
    if(v !== "") byStore.get(store_id).price_jpy_tax = Number(v); // âœ… ç©ºç™½ä¸é€å‡º
  }


  // è‡ªå‹•è£œé½Šæ—¥æœ¬åƒ¹æ ¼ï¼šåªå¡«ã€Œå«ç¨…ã€â†’ç®—ã€Œæœªç¨…ã€ï¼›åªå¡«ã€Œæœªç¨…ã€â†’ç®—ã€Œå«ç¨…ã€
  const taxRateNow = getCurrentTaxRateForDetail_(p);
  for(const [store_id, priceObj] of byStore.entries()){
    const hasUntaxed = Object.prototype.hasOwnProperty.call(priceObj, "price_jpy_untaxed");
    const hasTax     = Object.prototype.hasOwnProperty.call(priceObj, "price_jpy_tax");

    if(hasTax && !hasUntaxed){
      const u = calcUntaxedFromTax_(priceObj.price_jpy_tax, taxRateNow);
      if(u != null) priceObj.price_jpy_untaxed = u;
    } else if(hasUntaxed && !hasTax){
      priceObj.price_jpy_tax = calcTaxFromUntaxed_(priceObj.price_jpy_untaxed, taxRateNow);
    }
  }

  // çµ„ tasksï¼šåªé€ã€ŒçœŸçš„æœ‰å¡«åˆ°ã€çš„æ¬„ä½ï¼Œé¿å…æŠŠå¦ä¸€æ¬„æ¸…ç©º
  const tasks = [];
  for(const [store_id, priceObj] of byStore.entries()){
    const hasAny =
      Object.prototype.hasOwnProperty.call(priceObj, "price_twd") ||
      Object.prototype.hasOwnProperty.call(priceObj, "price_jpy_untaxed") ||
      Object.prototype.hasOwnProperty.call(priceObj, "price_jpy_tax");

    if(!hasAny) continue;

    tasks.push(apiPost("upsertProduct", {
      product_id: p.id,
      name: p.name,
      spec: p.spec,
      category_id: p.category_id,
      store_id,
      photo: p.photo || "",
      ...priceObj
    }));
  }

  if(!tasks.length){
    setMsg("price_msg","æ²’æœ‰å¯å„²å­˜çš„åƒ¹æ ¼ï¼ˆè«‹åœ¨ä»»ä¸€åº—å®¶è¼¸å…¥æ•¸å­—ï¼‰",true);
    return;
  }

  try{
    setMsg("price_msg","å„²å­˜ä¸­â€¦",false);
    await Promise.all(tasks);
    setMsg("price_msg","å·²å„²å­˜æˆåŠŸï¼Œæ­£åœ¨é‡æ–°è¼‰å…¥â€¦",false);

    await loadFromSheets();

    // é‡æ–°é–‹å•ŸåŒä¸€å•†å“ï¼ˆåˆ·æ–°é¡¯ç¤ºï¼‰
    const updated = (products||[]).find(x=>String(x.id)===String(p.id));
    if(updated) openDetail(updated);
  }catch(err){
    console.error(err);
    setMsg("price_msg","å„²å­˜å¤±æ•—ï¼š" + (err.message || err),true);
  }
}


  function parseDetailRates_(){
    const fx = parseFloat(document.getElementById("d_fx")?.value || "");
    const tax = parseFloat(document.getElementById("d_tax")?.value || "");
    if(isNaN(fx) || fx<=0){ alert("åŒ¯ç‡æ ¼å¼ä¸æ­£ç¢º"); return null; }
    if(isNaN(tax) || tax<0){ alert("ç¨…ç‡æ ¼å¼ä¸æ­£ç¢º"); return null; }
    return { fx, tax };
  }

  function applyDetailRatesProduct(){
    if(!currentDetailProduct) return;
    const v = parseDetailRates_();
    if(!v) return;
    setProductOverrideRates(currentDetailProduct.id, v.fx, v.tax);
    openDetail(currentDetailProduct);
  }

  function clearDetailRatesProduct(){
    if(!currentDetailProduct) return;
    clearProductOverrideRates(currentDetailProduct.id);
    openDetail(currentDetailProduct);
  }

  function applyDetailRatesCategory(){
    if(!currentDetailProduct) return;
    const v = parseDetailRates_();
    if(!v) return;
    setOverrideRates(currentDetailProduct.category_id, v.fx, v.tax);
    openDetail(currentDetailProduct);
  }

  async function saveDetailRatesToCategory(){
    if(!currentDetailProduct) return;
    const cid = currentDetailProduct.category_id;
    const cat = categoriesById[cid] || { id: cid, name: currentDetailProduct.category_name || cid, color: currentDetailProduct.category_color || defaultColorForCategory(cid) };

    const fx = parseFloat(document.getElementById("d_fx")?.value || "");
    const tax = parseFloat(document.getElementById("d_tax")?.value || "");
    if(isNaN(fx) || fx<=0){ alert("åŒ¯ç‡æ ¼å¼ä¸æ­£ç¢º"); return; }
    if(isNaN(tax) || tax<0){ alert("ç¨…ç‡æ ¼å¼ä¸æ­£ç¢º"); return; }

    try{
      await apiPost("upsertCategory", {
        category_id: cid,
        category_name: cat.name,
        jpy_to_twd: fx,
        jp_tax_rate: tax,
        color: cat.color || defaultColorForCategory(cid)
      });
      // also keep local override consistent
      setOverrideRates(cid, fx, tax);

      // reload from Sheets so everyone sees latest
      await loadFromSheets();
      // reopen current product detail (it will use latest values)
      const latest = (products || []).find(x => x.id === currentDetailProduct.id) || currentDetailProduct;
      openDetail(latest);
      alert("å·²å„²å­˜åˆ°é¡åˆ¥è¨­å®šï¼ˆGoogle Sheetsï¼‰ã€‚");
    }catch(err){
      console.error(err);
      alert("å„²å­˜å¤±æ•—ï¼š" + (err.message || err));
    }
  }

  async function adminSaveCategory(){
    const msg = document.getElementById("adminMsg");
    const category_id = (document.getElementById("cat_id")?.value || "").trim();
    const category_name = (document.getElementById("cat_name")?.value || "").trim();
    const fx = parseFloat(document.getElementById("cat_fx")?.value || "");
    const tax = parseFloat(document.getElementById("cat_tax")?.value || "");
    const color = (document.getElementById("cat_color")?.value || "").trim();

    if(!category_id){ msg.textContent="category_id å¿…å¡«"; return; }
    if(!category_name){ msg.textContent="category_name å¿…å¡«"; return; }
    if(isNaN(fx) || fx<=0){ msg.textContent="åŒ¯ç‡æ ¼å¼ä¸æ­£ç¢º"; return; }
    if(isNaN(tax) || tax<0){ msg.textContent="ç¨…ç‡æ ¼å¼ä¸æ­£ç¢º"; return; }

    msg.textContent = "å„²å­˜ä¸­â€¦";
    try{
      await apiPost("upsertCategory", {
        category_id,
        category_name,
        jpy_to_twd: fx,
        jp_tax_rate: tax,
        color: color || defaultColorForCategory(category_id)
      });
      msg.textContent = "å·²å„²å­˜ã€‚æ­£åœ¨é‡æ–°è¼‰å…¥â€¦";
      await loadFromSheets();
      msg.textContent = "å®Œæˆã€‚";
    }catch(err){
      console.error(err);
      msg.textContent = "å„²å­˜å¤±æ•—ï¼š" + (err.message || err);
    }
  }




  // -------------------- Admin: Categories --------------------
  function adminSetMsg(text, isError=false){
    const el = document.getElementById("adminMsg");
    if(!el) return;
    el.textContent = text || "";
    el.style.color = isError ? "#b91c1c" : "";
  }

  async function adminSaveCategory(){
    adminSetMsg("");
    const category_id = (document.getElementById("cat_id")?.value || "").trim();
    const category_name = (document.getElementById("cat_name")?.value || "").trim();
    const jpy_to_twd = (document.getElementById("cat_fx")?.value || "").trim();
    const jp_tax_rate = (document.getElementById("cat_tax")?.value || "").trim();

    if(!category_id){ adminSetMsg("category_id å¿…å¡«", true); return; }
    if(!category_name){ adminSetMsg("category_name å¿…å¡«", true); return; }

    const data = {
      category_id,
      category_name,
      jpy_to_twd: jpy_to_twd === "" ? "" : Number(jpy_to_twd),
      jp_tax_rate: jp_tax_rate === "" ? "" : Number(jp_tax_rate),
    };

    try{
      const r = await apiPost("upsertCategory", data);
      adminSetMsg(`å„²å­˜æˆåŠŸï¼šrow=${r.row}ï¼ˆ${r.inserted ? "æ–°å¢" : "æ›´æ–°"}ï¼‰`);
      // refresh to sync UI/cache
      if(typeof loadFromSheets === "function") await loadFromSheets();
    }catch(err){
      console.error(err);
      adminSetMsg("å„²å­˜å¤±æ•—ï¼š" + (err.message || err), true);
    }
  }

  // -------------------- Settings actions --------------------
  function saveSheetId(){
    const v = document.getElementById("sheetInput").value.trim();
    if(!v){ alert("è«‹è²¼ä¸Šè©¦ç®—è¡¨ç¶²å€æˆ– Sheet ID"); return; }
    localStorage.setItem(KEY_SHEET, v);
    updateSourceInfo();
    alert("å·²å„²å­˜ã€‚å»ºè­°æŒ‰ã€Œè¼‰å…¥è³‡æ–™ã€æ¸¬è©¦ã€‚");
  }

  function updateSourceInfo(usingCache=false){
    const raw = localStorage.getItem(KEY_SHEET) || "";
    const id = extractSheetId(raw);
    const el = document.getElementById("sourceInfo");
    if(!id){
      el.textContent = "å°šæœªè¨­å®šã€‚è«‹åˆ°ã€Œè¨­å®šã€è²¼ä¸Šè©¦ç®—è¡¨ç¶²å€æˆ– Sheet IDã€‚";
      return;
    }
    el.textContent = `ç›®å‰ Sheet IDï¼š${id}${usingCache?"ï¼ˆé¡¯ç¤ºå¿«å–ï¼‰":""}`;
    document.getElementById("sheetInput").value = raw;
  }

  
// -------------------- Category ordering (drag & drop) --------------------
function getLocalCatOrder_(){
  try{ return JSON.parse(localStorage.getItem("dc_cat_order_v1") || "null"); }catch(_){ return null; }
}
function setLocalCatOrder_(arr){
  localStorage.setItem("dc_cat_order_v1", JSON.stringify(arr||[]));
}
function clearLocalCatOrder_(){ localStorage.removeItem("dc_cat_order_v1"); }

function applyLocalCatOrderToModel_(){
  const ord = getLocalCatOrder_();
  if(!ord || !Array.isArray(ord) || !ord.length) return;
  const pos = new Map(ord.map((cid, i)=>[String(cid), i]));
  Object.values(categoriesById||{}).forEach(c=>{
    const p = pos.get(String(c.id));
    if(p !== undefined) c.sort_order = p;
  });
}

function setSortMsg(text, isError=false){
  const el = document.getElementById("catSortMsg");
  if(!el) return;
  el.textContent = text || "";
  el.style.color = isError ? "#b91c1c" : "";
}

function currentOrderFromDOM_(){
  const wrap = document.getElementById("catSortList");
  if(!wrap) return [];
  return Array.from(wrap.querySelectorAll(".sortItem")).map(x=>x.dataset.cid);
}

function renderCategorySortUI(){
  const wrap = document.getElementById("catSortList");
  if(!wrap) return;
  wrap.innerHTML = "";

  applyLocalCatOrderToModel_();

  const cats = Object.values(categoriesById||{}).slice().sort((a,b)=>{
    const ao = (a.sort_order ?? 999999), bo = (b.sort_order ?? 999999);
    if(ao !== bo) return ao - bo;
    return compareNamesAdvanced(a.name, b.name);
  });

  cats.forEach((c, idx)=>{
    const item = document.createElement("div");
    item.className = "sortItem";
    item.dataset.cid = c.id;

    const handle = document.createElement("div");
    handle.className = "sortHandle";
    handle.textContent = "â‰¡";

    const meta = document.createElement("div");
    meta.className = "sortMeta";
    meta.innerHTML = `<div class="sortName">${escapeHtml(c.name)}</div><div class="sortId">${escapeHtml(c.id)}</div>`;

    const badge = document.createElement("div");
    badge.className = "sortBadge";
    badge.textContent = `#${idx+1}`;

    item.appendChild(handle);
    item.appendChild(meta);
    item.appendChild(badge);
    wrap.appendChild(item);
  });

  enablePointerSortable_(wrap);
}

function saveOrderLocalFromDOM_(){
  const ord = currentOrderFromDOM_();
  setLocalCatOrder_(ord);
  applyLocalCatOrderToModel_();
  try{ renderList(); }catch(_){}
  renderCategorySortUI();
}

function resetCategoryOrderLocal(){
  clearLocalCatOrder_();
  setSortMsg("å·²é‡ç½®ï¼ˆæ”¹ç”¨ Sheet å…§ sort_order æˆ–é è¨­é †åºï¼‰ã€‚", false);
  loadFromSheets().then(()=>renderCategorySortUI()).catch(()=>renderCategorySortUI());
}

async function saveCategoryOrderToSheet(){
  const ord = currentOrderFromDOM_();
  if(!ord.length){ setSortMsg("æ²’æœ‰é¡åˆ¥å¯å„²å­˜ã€‚", true); return; }
  setSortMsg("å„²å­˜ä¸­â€¦", false);

  try{
    const tasks = ord.map((cid, i)=>{
      const c = categoriesById[cid] || { id: cid, name: cid, color:"#6554f6", jpy_to_twd:0.2032, jp_tax_rate:0.10 };
      return apiPost("upsertCategory", {
        category_id: cid,
        category_name: c.name || cid,
        jpy_to_twd: Number(c.jpy_to_twd ?? 0.2032),
        jp_tax_rate: Number(c.jp_tax_rate ?? 0.10),
        color: c.color || "#6554f6",
        sort_order: i
      });
    });

    await Promise.all(tasks);
    setLocalCatOrder_(ord);
    setSortMsg("å·²å„²å­˜åˆ° Google Sheetsã€‚å…¶ä»–è£ç½®é‡æ–°è¼‰å…¥æœƒåŒæ­¥ã€‚", false);
    await loadFromSheets();
    renderCategorySortUI();
  }catch(err){
    console.error(err);
    setSortMsg("å„²å­˜å¤±æ•—ï¼š" + (err.message || err), true);
  }
}

// Pointer-based sortable (mobile friendly)
function enablePointerSortable_(container){
  let dragging = null;
  let startY = 0;

  function items(){ return Array.from(container.querySelectorAll(".sortItem")); }
  function indexOf(el){ return items().indexOf(el); }

  container.onpointerdown = (e)=>{
    const handle = e.target.closest(".sortHandle");
    if(!handle) return;
    const item = e.target.closest(".sortItem");
    if(!item) return;

    dragging = item;
    startY = e.clientY;
    item.classList.add("dragging");
    item.setPointerCapture(e.pointerId);
    e.preventDefault();
  };

  container.onpointermove = (e)=>{
    if(!dragging) return;
    const y = e.clientY;
    const dy = y - startY;

    const list = items();
    const curIndex = indexOf(dragging);
    if(curIndex < 0) return;

    const rect = dragging.getBoundingClientRect();
    const threshold = rect.height * 0.45;

    if(dy > threshold && curIndex < list.length - 1){
      const next = list[curIndex + 1];
      container.insertBefore(next, dragging);
      startY = y;
    }else if(dy < -threshold && curIndex > 0){
      const prev = list[curIndex - 1];
      container.insertBefore(dragging, prev);
      startY = y;
    }
  };

  const end = ()=>{
    if(!dragging) return;
    dragging.classList.remove("dragging");
    dragging = null;
    saveOrderLocalFromDOM_();
  };

  container.onpointerup = end;
  container.onpointercancel = end;
}


// -------------------- Boot --------------------
  updateSourceInfo();

  // If cache exists, show something immediately
  const cache = localStorage.getItem(KEY_CACHE);
  if(cache){
    try{
      const data = JSON.parse(cache);
      buildDataModel(data.cats||[], data.st||[], data.pr||[]);
      renderList();
    }catch(e){}
  }

  // -------------------- Add Product (FAB) --------------------
  function escapeHtml(s){
    return String(s ?? "").replace(/[&<>"']/g, c => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[c]));
  }


function hexToRgba(hex, a){
  const h = String(hex||"").trim();
  const m = h.match(/^#?([0-9a-fA-F]{6})$/);
  if(!m) return `rgba(101,84,246,${a})`;
  const n = parseInt(m[1], 16);
  const r = (n >> 16) & 255;
  const g = (n >> 8) & 255;
  const b = n & 255;
  return `rgba(${r},${g},${b},${a})`;
}
function charTypeRank(name){
  const s = (name||"").trim();
  if(!s) return 3;
  const ch = s[0];
  if(/[0-9]/.test(ch)) return 0;              // numbers
  if(/[A-Za-z]/.test(ch)) return 1;           // latin
  return 2;                                   // others (CJK etc.)
}
function nameLen(name){
  return (name||"").trim().length;
}
function compareNamesAdvanced(aName, bName){
  const ta = charTypeRank(aName), tb = charTypeRank(bName);
  if(ta !== tb) return ta - tb;

  const la = nameLen(aName), lb = nameLen(bName);
  if(la !== lb) return la - lb;

  if(ta === 1){
    return String(aName||"").toLowerCase().localeCompare(String(bName||"").toLowerCase(), "en");
  }
  return String(aName||"").localeCompare(String(bName||""), "zh-Hant");
}
function getProdOverride_(pid){
  try{
    return JSON.parse(localStorage.getItem("dc_prod_override_v1_" + pid) || "null");
  }catch(_){ return null; }
}
function getCatOverride_(cid){
  try{
    return JSON.parse(localStorage.getItem("dc_cat_override_v1_" + cid) || "null");
  }catch(_){ return null; }
}


  function nextProductId(){
    const ids = (products || []).map(p => parseInt(p.id, 10)).filter(n => !isNaN(n));
    const maxId = ids.length ? Math.max(...ids) : 0;
    return String(maxId + 1);
  }

  function openAddProduct(){
    if(!products || products.length === 0){
      alert("è«‹å…ˆåˆ°ã€Œè¨­å®šã€æŒ‰ã€Œè¼‰å…¥è³‡æ–™ã€ï¼Œè®€å…¥ç›®å‰çš„ Google Sheetsã€‚");
      return;
    }

    document.getElementById("d_title").textContent = "æ–°å¢å•†å“";
    document.getElementById("d_sub").textContent = "å¡«å®ŒæŒ‰ã€Œå„²å­˜ã€ï¼Œæœƒå¯«å› Google Sheetsï¼ˆproducts åˆ†é ï¼‰ã€‚åŒä¸€å•†å“å¯æ–°å¢å¤šå®¶åº—çš„åƒ¹æ ¼ã€‚";

    const blocks = document.getElementById("d_blocks");
    const pid = nextProductId();

    const catOptions = Object.values(categoriesById || {}).map(c =>
      `<option value="${escapeHtml(c.id)}">${escapeHtml(c.name)} (${escapeHtml(c.id)})</option>`
    ).join("");

    blocks.innerHTML = `
      <div class="block">
        <div class="bt">å•†å“åŸºæœ¬è³‡æ–™</div>
        <div style="display:grid;gap:8px;">
          <div class="small">product_idï¼ˆè‡ªå‹•å¸¶å…¥ï¼Œå¯æ”¹ï¼Œä½†å»ºè­°ä¸è¦é‡è¤‡ï¼‰</div>
          <input id="ap_pid" class="inp" value="${escapeHtml(pid)}" />
          <input id="ap_name" class="inp" placeholder="å•†å“åç¨±ï¼ˆå¿…å¡«ï¼‰" />
          <input id="ap_spec" class="inp" placeholder="è¦æ ¼ï¼ˆä¾‹å¦‚ 50g / 170mlï¼‰" />
          <select id="ap_cat" class="inp">
            <option value="">é¸æ“‡é¡åˆ¥ï¼ˆå¿…å¡«ï¼‰</option>
            ${catOptions}
          </select>
          <input id="ap_photo" class="inp" placeholder="ç…§ç‰‡ URLï¼ˆå¯é¸ï¼Œè‹¥ products åˆ†é æœ‰ photo æ¬„ä½æ‰æœƒå¯«å…¥ï¼‰" />
        </div>
      </div>

      <div class="block">
        <div class="bt">åº—å®¶åƒ¹æ ¼ï¼ˆå¯æ–°å¢å¤šç­†ï¼‰</div>
        <div id="ap_prices" style="display:grid;gap:10px;"></div>
        <div class="row" style="margin-top:8px;">
          <button class="btn secondary" type="button" onclick="apAddPriceRow()">ï¼‹æ–°å¢ä¸€ç­†åº—å®¶åƒ¹æ ¼</button>
        </div>
        <div class="small" style="margin-top:6px;">
          å°ç£åº—å¡« price_twdï¼›æ—¥æœ¬åº—å¡« price_jpy_untaxed / price_jpy_taxï¼ˆå¯åªå¡«æœªç¨…ï¼‰ã€‚
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <button class="btn" style="width:100%;" type="button" onclick="saveAddProduct()">å„²å­˜åˆ° Google Sheets</button>
      </div>

      <div class="small" id="ap_msg" style="margin-top:8px;"></div>
    `;

    apAddPriceRow();
    document.getElementById("bd").classList.add("active");
  }

  function apAddPriceRow(){
    const wrap = document.getElementById("ap_prices");
    if(!wrap){ return; }
    const idx = wrap.children.length + 1;

    const storeOptions = (stores || []).map(s => {
      const label = `${s.store_name} (${s.country})`;
      return `<option value="${escapeHtml(s.store_id)}">${escapeHtml(label)}</option>`;
    }).join("");

    const row = document.createElement("div");
    row.className = "block";
    row.innerHTML = `
      <div class="bt">åƒ¹æ ¼ #${idx}</div>
      <div style="display:grid;gap:8px;">
        <select class="inp ap_store">
          <option value="">é¸æ“‡åº—å®¶ï¼ˆå¿…å¡«ï¼‰</option>
          ${storeOptions}
        </select>
        <input class="inp ap_twd" type="number" inputmode="numeric" step="1" placeholder="å°ç£åƒ¹æ ¼ price_twdï¼ˆä¾‹å¦‚ 299ï¼‰" />
        <input class="inp ap_jpu" type="number" inputmode="numeric" step="1" placeholder="æ—¥æœ¬æœªç¨… price_jpy_untaxedï¼ˆä¾‹å¦‚ 1470ï¼‰" />
        <input class="inp ap_jpt" type="number" inputmode="numeric" step="1" placeholder="æ—¥æœ¬å«ç¨… price_jpy_taxï¼ˆä¾‹å¦‚ 1617ï¼‰" />
        <button class="btn secondary" type="button">åˆªé™¤æ­¤ç­†</button>
      </div>
    `;
    row.querySelector("button").onclick = () => row.remove();
    wrap.appendChild(row);
  }

  function apSetMsg(text, isError=false){
    const el = document.getElementById("ap_msg");
    if(!el) return;
    el.textContent = text || "";
    el.style.color = isError ? "#b91c1c" : "";
  }

  async function saveAddProduct(){
    apSetMsg("");

    const product_id = (document.getElementById("ap_pid")?.value || "").trim();
    const name = (document.getElementById("ap_name")?.value || "").trim();
    const spec = (document.getElementById("ap_spec")?.value || "").trim();
    const category_id = (document.getElementById("ap_cat")?.value || "").trim();
    const photo = (document.getElementById("ap_photo")?.value || "").trim();

    if(!product_id){ apSetMsg("product_id å¿…å¡«", true); return; }
    if(!name){ apSetMsg("å•†å“åç¨±å¿…å¡«", true); return; }
    if(!category_id){ apSetMsg("é¡åˆ¥å¿…å¡«", true); return; }

    const priceBlocks = Array.from(document.querySelectorAll("#ap_prices .block"));
    if(priceBlocks.length === 0){
      apSetMsg("è‡³å°‘æ–°å¢ä¸€ç­†åº—å®¶åƒ¹æ ¼", true);
      return;
    }

    const tasks = [];
    for(const b of priceBlocks){
      const store_id = (b.querySelector(".ap_store")?.value || "").trim();
      const price_twd = (b.querySelector(".ap_twd")?.value || "").trim();
      const price_jpy_untaxed = (b.querySelector(".ap_jpu")?.value || "").trim();
      const price_jpy_tax = (b.querySelector(".ap_jpt")?.value || "").trim();

      if(!store_id) continue;

      const payload = {
        product_id, name, spec, category_id, store_id,
        photo,
        price_twd: price_twd === "" ? "" : Number(price_twd),
        price_jpy_untaxed: price_jpy_untaxed === "" ? "" : Number(price_jpy_untaxed),
        price_jpy_tax: price_jpy_tax === "" ? "" : Number(price_jpy_tax),
      };

      tasks.push(apiPost("upsertProduct", payload));
    }

    if(tasks.length === 0){
      apSetMsg("è«‹è‡³å°‘é¸æ“‡ä¸€å€‹åº—å®¶ä¸¦å¡«å…¥åƒ¹æ ¼ï¼ˆå°ç£æˆ–æ—¥æœ¬æ“‡ä¸€å³å¯ï¼‰", true);
      return;
    }

    try{
      apSetMsg("å„²å­˜ä¸­â€¦");
      await Promise.all(tasks);
      apSetMsg("å„²å­˜æˆåŠŸï¼Œé‡æ–°è¼‰å…¥ä¸­â€¦");
      await loadFromSheets();
      closeDetail();
      show("list");
    }catch(err){
      console.error(err);
      apSetMsg("å„²å­˜å¤±æ•—ï¼š" + (err.message || err), true);
    }
  }

</script>
</body>
</html>
