<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>DrugCompare â€“ å¤šåœ‹å¤šå¹£åˆ¥ï¼ˆ5 Sheets ç‰ˆï¼‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{--p:#6554f6;--pl:#ebe9ff;--bg:#f5f5fb;--t:#1f2933;--s:#7b8794;--danger:#b91c1c}
    *{box-sizing:border-box}
    body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",system-ui,sans-serif;background:var(--bg);color:var(--t)}
    .app{max-width:560px;margin:0 auto;min-height:100vh;background:#fff;box-shadow:0 0 30px rgba(0,0,0,.06)}
    header{padding:14px 18px 10px;position:sticky;top:0;background:#fff;z-index:9;border-bottom:1px solid #eef0f6}
    .brand{font-weight:900;color:var(--p);font-size:18px}
    .brand span{font-weight:600;color:var(--s);font-size:12px;margin-left:6px}
    main{padding:0 14px 80px;background:linear-gradient(180deg,#f5f5fb 0%,#fff 42%)}
    .screen{display:none;animation:in .18s ease-out}
    .screen.active{display:block}
    @keyframes in{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:translateY(0)}}
    .title{font-size:18px;font-weight:800;margin:10px 0}
    .card{background:#fff;border-radius:16px;padding:12px;box-shadow:0 8px 18px rgba(15,23,42,.08);margin-bottom:10px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .btn{border:none;border-radius:999px;padding:9px 12px;background:var(--p);color:#fff;font-size:13px;cursor:pointer}
    .btn.secondary{background:#e5e7eb;color:#374151}
    .btn.danger{background:var(--danger)}
    .inp,.sel{width:100%;border:1px solid #e5e7eb;border-radius:12px;padding:10px 12px;background:#fff;font-size:14px;outline:none}
    .small{font-size:12px;color:var(--s);line-height:1.45}
    .pill{display:inline-flex;background:#eef2ff;border-radius:999px;padding:4px}
    .pill button{border:none;background:transparent;border-radius:999px;padding:7px 12px;font-size:12px;color:var(--s);cursor:pointer}
    .pill button.active{background:#fff;color:var(--p);box-shadow:0 4px 10px rgba(101,84,246,.25)}
    .list{display:flex;flex-direction:column;gap:10px}
    .catBlock{border-radius:18px;padding:10px;margin:10px 0 14px;box-shadow:0 8px 18px rgba(15,23,42,.08)}
    .catHeader{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .catName{font-weight:900}
    .item{display:flex;gap:12px;align-items:flex-start;background:#fff;border-radius:16px;padding:10px;box-shadow:0 6px 14px rgba(15,23,42,.1);cursor:pointer}
    .thumb{width:56px;height:56px;border-radius:16px;background:#e5e7f5;overflow:hidden;display:flex;align-items:center;justify-content:center;font-size:11px;color:var(--s);flex:0 0 auto}
    .thumb img{width:100%;height:100%;object-fit:cover}
    .name{font-size:14px;font-weight:800;margin-bottom:2px}
    .spec{font-size:11px;color:var(--s);margin-bottom:6px}
    .meta{display:flex;justify-content:space-between;align-items:center;margin-bottom:2px}
    .tag{font-size:10px;padding:2px 8px;border-radius:999px;background:#f3f4ff;color:var(--p);border:1px solid #e8e5ff}
    .sum{font-size:11px;color:var(--s)}
    .sum strong{font-size:13px;color:var(--p)}
    .nav{position:fixed;left:50%;bottom:0;transform:translateX(-50%);width:100%;max-width:560px;background:#fff;border-top:1px solid #e0e5f2;padding:8px 16px 12px;display:flex;gap:6px}
    .nav .n{flex:1;text-align:center;font-size:10px;color:var(--s);cursor:pointer}
    .nav .i{width:26px;height:26px;border-radius:999px;margin:0 auto 2px;display:flex;align-items:center;justify-content:center;font-size:13px;color:var(--s)}
    .nav .n.active{color:var(--p)}
    .nav .n.active .i{background:var(--p);color:#fff}
    .fab{
      position: fixed; right: calc(50% - 280px + 16px); bottom: 90px;
      width: 54px; height: 54px; border-radius: 999px; border: none;
      background: var(--p); color:#fff; font-size:28px; box-shadow:0 14px 30px rgba(101,84,246,.35);
      cursor:pointer; z-index:60;
    }
    @media (max-width: 560px){ .fab{ right: 16px; } }
    .backdrop{position:fixed;inset:0;background:rgba(15,23,42,.45);display:none;align-items:flex-end;justify-content:center;z-index:50}
    .backdrop.active{display:flex}
    .sheet{width:100%;max-width:560px;background:#fff;border-radius:20px 20px 0 0;padding:12px 14px 18px;max-height:84vh;overflow:auto;box-shadow:0 -6px 18px rgba(0,0,0,.25)}
    .handle{width:40px;height:4px;border-radius:999px;background:#e5e7eb;margin:0 auto 10px}
    .sheet h3{margin:0 0 4px;font-size:16px}
    .sheet .sub{font-size:12px;color:var(--s);margin-bottom:10px}
    .block{background:#f9fafb;border-radius:14px;padding:10px;margin-bottom:10px;border:1px solid #eef0f6}
    .block .bt{font-weight:900;font-size:13px;margin-bottom:8px}
    .sr{display:flex;justify-content:space-between;gap:12px;margin-bottom:8px;align-items:center}
    .sn{font-weight:800}
    .note{font-size:11px;color:var(--s)}
    .line{font-size:12px}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .msg{font-size:12px;margin-top:8px}
    .msg.ok{color:#065f46}
    .msg.err{color:var(--danger)}
  </style>
</head>
<body>
<div class="app">
  <header>
    <div class="brand">DrugCompare <span>5 Sheets / å¤šåœ‹å¤šå¹£åˆ¥</span></div>
  </header>

  <main>
    <section id="home" class="screen active">
      <div class="title">é¦–é </div>
      <div class="card">
        <div style="font-weight:900;margin-bottom:6px;">è³‡æ–™ä¾†æºï¼ˆGoogle Sheetsï¼‰</div>
        <div class="small" id="sourceInfo">å°šæœªè¨­å®šã€‚è«‹åˆ°ã€Œè¨­å®šã€è²¼ä¸Šè©¦ç®—è¡¨ç¶²å€æˆ– Sheet IDã€‚</div>
        <div class="row" style="margin-top:10px;">
          <button class="btn" onclick="openList()">æŸ¥çœ‹å•†å“</button>
          <button class="btn secondary" onclick="openSettings()">è¨­å®š</button>
        </div>
      </div>
      <div class="card">
        <div style="font-weight:900;margin-bottom:6px;">ä½ ç›®å‰çš„ 5 Sheets</div>
        <div class="small">
          categories / stores / products / prices / fx_rates<br/>
          è®€å–ï¼šç”¨ gviz CSVï¼ˆéœ€é–‹æ”¾æª¢è¦–æˆ–ç™¼ä½ˆï¼‰ã€‚<br/>
          å¯«å…¥ï¼šé€é Apps Script Web Appï¼ˆJSONPï¼‰ï¼Œå¯å¾æ‰‹æ©Ÿ/å¹³æ¿ç›´æ¥æ–°å¢èˆ‡ä¿®æ”¹ã€‚
        </div>
      </div>
    </section>

    <section id="list" class="screen">
      <div class="row" style="margin-top:10px;justify-content:space-between;">
        <div style="font-weight:900;font-size:18px;">å•†å“</div>
        <div class="pill">
          <button id="f_all" class="active" onclick="setFilter('all')">å…¨éƒ¨</button>
          <button id="f_tw" onclick="setFilter('TW')">å°ç£</button>
          <button id="f_jp" onclick="setFilter('JP')">æ—¥æœ¬</button>
        </div>
      </div>

      <input id="q" class="inp" style="margin-top:10px" placeholder="æœå°‹å•†å“ / é¡åˆ¥ / åº—å®¶" oninput="renderList()" />
      <div class="small" style="margin:6px 2px 10px;">
        æ’åºï¼šé¡åˆ¥åˆ†å€ï¼ˆå¯ç”¨ sort_orderï¼‰â†’ åŒé¡åˆ¥æŒ‰ã€Œåç¨±å­—æ•¸ã€â†’ æ•¸å­— â†’ è‹±æ–‡ â†’ ä¸­æ–‡ã€‚
      </div>

      <div id="listWrap"></div>
    </section>

    <section id="admin" class="screen">
      <div class="title">ç®¡ç†</div>

      <div class="card">
        <div style="font-weight:900;margin-bottom:6px;">é¡åˆ¥ï¼ˆé¡è‰² / é è¨­ç¨…ç‡ / æ’åºï¼‰</div>
        <div class="small">æ­¤é æ˜¯ã€Œå¿«é€Ÿç·¨è¼¯ã€ã€‚å®Œæ•´ç®¡ç†å»ºè­°ä»åœ¨ Google Sheets æ“ä½œã€‚</div>

        <div class="grid2" style="margin-top:10px;">
          <input id="cat_id" class="inp" placeholder="category_idï¼ˆå¦‚ drugstoreï¼‰" />
          <input id="cat_name" class="inp" placeholder="category_nameï¼ˆå¦‚ è—¥å¦é¡ï¼‰" />
        </div>
        <div class="grid2" style="margin-top:8px;">
          <input id="cat_color" class="inp" placeholder="colorï¼ˆå¦‚ #E8F0FFï¼Œå¯ç©ºï¼‰" />
          <input id="cat_order" class="inp" placeholder="sort_orderï¼ˆæ•¸å­—ï¼Œå¯ç©ºï¼‰" />
        </div>
        <div class="grid2" style="margin-top:8px;">
          <input id="cat_tax" class="inp" placeholder="default_tax_rateï¼ˆå¦‚ 0.1 æˆ– 10ï¼‰" />
          <input id="cat_fx" class="inp" placeholder="default_fx_to_twdï¼ˆå¦‚ 0.2032ï¼Œå¯ç©ºï¼‰" />
        </div>

        <div class="row" style="margin-top:10px;">
          <button class="btn" onclick="adminSaveCategory()">å„²å­˜é¡åˆ¥</button>
          <button class="btn secondary" onclick="loadAll()">é‡æ–°è¼‰å…¥</button>
        </div>
        <div id="adminMsg" class="msg"></div>
      </div>

      <div class="card">
        <div style="font-weight:900;margin-bottom:6px;">åŒ¯ç‡ï¼ˆfx_ratesï¼‰</div>
        <div class="small">pair ä¾‹å¦‚ JPY_TWD, USD_TWDã€‚ä½ ä¹Ÿå¯åœ¨å•†å“å½ˆçª—æš«æ™‚è¦†å¯«ï¼ˆä¸å¯«å›ï¼‰ã€‚</div>
        <div class="grid2" style="margin-top:10px;">
          <input id="fx_pair" class="inp" placeholder="pairï¼ˆå¦‚ JPY_TWDï¼‰" />
          <input id="fx_rate" class="inp" placeholder="rateï¼ˆå¦‚ 0.2032ï¼‰" />
        </div>
        <div class="row" style="margin-top:10px;">
          <button class="btn" onclick="adminSaveFx()">å„²å­˜åŒ¯ç‡</button>
        </div>
        <div id="fxMsg" class="msg"></div>
      </div>
    </section>

    <section id="settings" class="screen">
      <div class="title">è¨­å®š</div>

      <div class="card">
        <div style="font-weight:900;margin-bottom:6px;">è©¦ç®—è¡¨ç¶²å€æˆ– Sheet ID</div>
        <input id="sheetInput" class="inp" placeholder="è²¼ä¸Šæ•´å€‹ Google Sheets ç¶²å€ï¼Œæˆ–è²¼ Sheet IDï¼ˆé‚£ä¸²è‹±æ–‡æ•¸å­—ï¼‰" />
        <div class="small" style="margin-top:6px;">
          Sheet ID åœ¨ç¶²å€ä¸­ï¼š<br/>
          https://docs.google.com/spreadsheets/d/<b>é€™ä¸€ä¸²</b>/edit
        </div>
        <div class="row" style="margin-top:10px;">
          <button class="btn" onclick="saveSheetId()">å„²å­˜</button>
          <button class="btn secondary" onclick="loadAll()">è¼‰å…¥è³‡æ–™</button>
        </div>
        <div class="small" id="loadStatus" style="margin-top:8px;"></div>
      </div>

      <div class="card">
        <div style="font-weight:900;margin-bottom:6px;">Apps Script Web Appï¼ˆå¯«å…¥ç”¨ï¼‰</div>
        <input id="apiUrlInput" class="inp" placeholder="è²¼ä¸Š Web App URLï¼ˆhttps://script.google.com/macros/s/.../execï¼‰" />
        <input id="apiTokenInput" class="inp" style="margin-top:8px" placeholder="è²¼ä¸Š tokenï¼ˆä½ åœ¨ Apps Script è¨­å®šçš„ EDIT_TOKENï¼‰" />
        <div class="row" style="margin-top:10px;">
          <button class="btn" onclick="saveApi()">å„²å­˜</button>
        </div>
        <div class="small" style="margin-top:8px;">
          è‹¥ä½ ä¸æƒ³æŠŠ token å¯«åœ¨å‰ç«¯ï¼Œå¯æ”¹ç”¨ Apps Script çš„ç™½åå–® emailï¼ˆä½†å¤–éƒ¨è£ç½®å¯èƒ½æ‹¿ä¸åˆ° emailï¼‰ã€‚
        </div>
      </div>

      <div class="card">
        <div style="font-weight:900;margin-bottom:6px;">å¿«å–</div>
        <div class="small">App æœƒä¿ç•™ä¸Šæ¬¡æˆåŠŸè¼‰å…¥çš„å¿«å–ï¼ˆé›¢ç·šä¹Ÿèƒ½çœ‹ï¼‰ã€‚</div>
        <div class="row" style="margin-top:10px;">
          <button class="btn secondary" onclick="clearCache()">æ¸…é™¤å¿«å–</button>
        </div>
      </div>
    </section>
  </main>

  <button class="fab" id="fabAdd" onclick="openAddProduct()" title="æ–°å¢å•†å“">ï¼‹</button>

  <nav class="nav">
    <div class="n active" id="nav_home" onclick="go('home')"><div class="i">ğŸ </div>é¦–é </div>
    <div class="n" id="nav_list" onclick="openList()"><div class="i">ğŸ“‹</div>å•†å“</div>
    <div class="n" id="nav_admin" onclick="go('admin')"><div class="i">ğŸ› </div>ç®¡ç†</div>
    <div class="n" id="nav_set" onclick="openSettings()"><div class="i">âš™ï¸</div>è¨­å®š</div>
  </nav>
</div>

<div id="bd" class="backdrop">
  <div class="sheet">
    <div class="handle"></div>
    <h3 id="d_title"></h3>
    <div class="sub" id="d_sub"></div>
    <div id="d_blocks"></div>
    <div id="d_msg" class="msg"></div>
    <div class="row" style="margin-top:6px;">
      <button class="btn secondary" style="flex:1" onclick="closeDetail()">é—œé–‰</button>
      <button class="btn" style="flex:1" onclick="saveDetail()">å„²å­˜ï¼ˆå¯«å› Sheetsï¼‰</button>
    </div>
  </div>
</div>

<script>
const KEY_SHEET = "dc5_sheet_id_or_url";
const KEY_CACHE = "dc5_cache_v1";
const KEY_API_URL = "dc5_api_url";
const KEY_API_TOKEN = "dc5_api_token";

let filterCountry = "all";
let categories = [];
let stores = [];
let products = [];
let prices = [];
let fxRates = [];

let categoriesById = {};
let storesById = {};
let storesByCat = {};
let productsById = {};
let pricesByKey = {};

let currentDetailProductId = null;

function show(id){
  document.querySelectorAll(".screen").forEach(s=>s.classList.remove("active"));
  const el = document.getElementById(id);
  if(el) el.classList.add("active");
  ["home","list","admin","settings"].forEach(k=>{
    const n = document.getElementById("nav_"+(k==="settings"?"set":k));
    if(n) n.classList.toggle("active", k===id || (id==="settings" && k==="settings"));
  });
}
function go(id){ show(id); }
function openSettings(){ show("settings"); }
function openList(){ show("list"); setFilter(filterCountry); renderList(); }
function setFilter(c){
  filterCountry = c || "all";
  ["all","TW","JP"].forEach(k=>{
    const id = "f_" + (k==="all"?"all":k.toLowerCase());
    const b = document.getElementById(id);
    if(b) b.classList.toggle("active", filterCountry===k);
  });
  renderList();
}

function escapeHtml(s){
  return String(s ?? "").replace(/[&<>"']/g, c => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[c]));
}
function extractSheetId(input){
  const t = (input||"").trim();
  if(!t) return "";
  const m = t.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
  if(m && m[1]) return m[1];
  return t;
}
function normalizeTaxRate_(v, fallback = 0.10){
  let n = Number(v);
  if(!isFinite(n)) return fallback;
  if(n > 1 && n <= 100) n = n / 100;
  if(n < 0 || n > 0.50) return fallback;
  return n;
}
function cleanNumber_(v){
  if(v === null || v === undefined) return "";
  const s = String(v).trim();
  if(!s) return "";
  const t = s.replace(/[ï¿¥Â¥]|NT\$|TWD|JPY|USD|EUR|KRW|CNY|HKD|SGD|THB|MYR/gi, "")
             .replace(/,/g,"").replace(/\s+/g,"");
  const n = Number(t);
  return isFinite(n) ? n : "";
}
function scoreMatch(text, q){
  if(!q) return 9999;
  text = (text||"").toLowerCase();
  q = q.toLowerCase();
  if(text === q) return 0;
  if(text.startsWith(q)) return 1;
  const idx = text.indexOf(q);
  if(idx >= 0) return 10 + idx;
  return 999999;
}
function typeRank_(s){
  const ch = (s||"").trim().charAt(0);
  if(!ch) return 9;
  if(/[0-9]/.test(ch)) return 0;
  if(/[A-Za-z]/.test(ch)) return 1;
  if(/[\u4E00-\u9FFF]/.test(ch)) return 2;
  return 3;
}
function productSortKey_(name){
  const n = (name||"").trim();
  return {len: n.length, type: typeRank_(n), text: n};
}

function parseCsv(text){
  if(!text) return [];
  if(text.charCodeAt(0) === 0xFEFF) text = text.slice(1);
  const rows = [];
  let row = [];
  let cur = "";
  let inQ = false;
  for(let i=0;i<text.length;i++){
    const ch = text[i], next = text[i+1];
    if(ch === '"'){
      if(inQ && next === '"'){ cur+='"'; i++; }
      else inQ = !inQ;
    } else if(ch === ',' && !inQ){
      row.push(cur); cur="";
    } else if((ch === '\n' || ch === '\r') && !inQ){
      if(ch === '\r' && next === '\n') i++;
      row.push(cur); cur="";
      const allEmpty = row.every(c => (c||"").trim()==="");
      if(!allEmpty) rows.push(row);
      row = [];
    } else cur += ch;
  }
  row.push(cur);
  const allEmpty = row.every(c => (c||"").trim()==="");
  if(!allEmpty) rows.push(row);
  return rows;
}
function rowsToObjects(rows){
  if(!rows.length) return [];
  const header = rows[0].map(h => (h||"").trim());
  const out = [];
  for(let i=1;i<rows.length;i++){
    const r = rows[i];
    const obj = {};
    header.forEach((h,idx)=> obj[h] = (r[idx] ?? "").trim());
    out.push(obj);
  }
  return out;
}

async function fetchSheetCsv(sheetId, sheetName){
  const url = `https://docs.google.com/spreadsheets/d/${encodeURIComponent(sheetId)}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(sheetName)}`;
  const res = await fetch(url, { cache: "no-store" });
  if(!res.ok) throw new Error(`è®€å– ${sheetName} å¤±æ•—ï¼ˆHTTP ${res.status}ï¼‰`);
  return await res.text();
}
async function loadAll(){
  const status = document.getElementById("loadStatus");
  if(status) status.textContent = "è¼‰å…¥ä¸­â€¦";
  try{
    const raw = localStorage.getItem(KEY_SHEET) || "";
    const sheetId = extractSheetId(raw);
    if(!sheetId) throw new Error("è«‹å…ˆåœ¨è¨­å®šå„²å­˜ Sheet ID/ç¶²å€");

    const [csvCat, csvStores, csvProd, csvPrices, csvFx] = await Promise.all([
      fetchSheetCsv(sheetId, "categories"),
      fetchSheetCsv(sheetId, "stores"),
      fetchSheetCsv(sheetId, "products"),
      fetchSheetCsv(sheetId, "prices"),
      fetchSheetCsv(sheetId, "fx_rates"),
    ]);

    categories = rowsToObjects(parseCsv(csvCat));
    stores     = rowsToObjects(parseCsv(csvStores));
    products   = rowsToObjects(parseCsv(csvProd));
    prices     = rowsToObjects(parseCsv(csvPrices));
    fxRates    = rowsToObjects(parseCsv(csvFx));

    buildModel();

    localStorage.setItem(KEY_CACHE, JSON.stringify({categories,stores,products,prices,fxRates,at:Date.now()}));
    if(status) status.textContent = "è¼‰å…¥æˆåŠŸã€‚";
    updateSourceInfo();
    renderList();
    show("list");
  }catch(err){
    console.error(err);
    if(status) status.textContent = "è¼‰å…¥å¤±æ•—ï¼š" + (err.message || err);
    const cache = localStorage.getItem(KEY_CACHE);
    if(cache){
      try{
        const data = JSON.parse(cache);
        categories = data.categories||[];
        stores = data.stores||[];
        products = data.products||[];
        prices = data.prices||[];
        fxRates = data.fxRates||[];
        buildModel();
        if(status) status.textContent += "ï¼ˆå·²ä½¿ç”¨å¿«å–é¡¯ç¤ºï¼‰";
        updateSourceInfo(true);
        renderList();
      }catch(_){}
    }
  }
}
function clearCache(){
  localStorage.removeItem(KEY_CACHE);
  alert("å·²æ¸…é™¤å¿«å–ã€‚");
}

function buildModel(){
  categoriesById = {};
  categories.forEach(c=>{
    const id = c.category_id;
    if(!id) return;
    categoriesById[id] = {
      id,
      name: c.category_name || id,
      color: c.color || "",
      sort_order: cleanNumber_(c.sort_order) === "" ? null : Number(cleanNumber_(c.sort_order)),
      default_tax_rate: normalizeTaxRate_(c.default_tax_rate, 0.10),
      default_fx_to_twd: cleanNumber_(c.default_fx_to_twd) === "" ? null : Number(cleanNumber_(c.default_fx_to_twd)),
    };
  });

  storesById = {};
  storesByCat = {};
  stores.forEach(s=>{
    const store_id = s.store_id;
    if(!store_id) return;
    const obj = {
      store_id,
      store_name: s.store_name || store_id,
      country_code: (s.country_code || s.country || "").toUpperCase(),
      currency: (s.currency||"").toUpperCase(),
      category_id: s.category_id || "",
      enabled: (String(s.enabled||"TRUE").toUpperCase() !== "FALSE")
    };
    storesById[store_id] = obj;
    if(!storesByCat[obj.category_id]) storesByCat[obj.category_id] = [];
    if(obj.enabled) storesByCat[obj.category_id].push(obj);
  });

  productsById = {};
  products.forEach(p=>{
    const pid = p.product_id;
    if(!pid) return;
    productsById[pid] = {
      product_id: pid,
      name: p.name || "",
      spec: p.spec || "",
      category_id: p.category_id || "",
      photo_url: p.photo_url || p.photo || "",
      active: (String(p.active||"TRUE").toUpperCase() !== "FALSE"),
      override_tax_rate: (p.override_tax_rate ? normalizeTaxRate_(p.override_tax_rate, null) : null),
      override_fx_to_twd: (cleanNumber_(p.override_fx_to_twd) === "" ? null : Number(cleanNumber_(p.override_fx_to_twd))),
    };
  });

  pricesByKey = {};
  prices.forEach(r=>{
    const pid = r.product_id || "";
    const sid = r.store_id || "";
    const pt = (r.price_type || "").toUpperCase();
    if(!pid || !sid || !pt) return;
    const key = `${pid}|${sid}|${pt}`;
    pricesByKey[key] = {
      price_id: r.price_id || key,
      product_id: pid,
      store_id: sid,
      price_type: pt,
      amount: cleanNumber_(r.amount),
      tax_rate: (r.tax_rate ? normalizeTaxRate_(r.tax_rate, null) : null),
      note: r.note || ""
    };
  });
}

function getFxToTwd_(currency){
  const c = (currency||"").toUpperCase();
  if(!c || c==="TWD") return 1;
  const pair = `${c}_TWD`;
  const row = fxRates.find(x => (x.pair||"").toUpperCase() === pair);
  const n = row ? cleanNumber_(row.rate) : "";
  return n === "" ? null : Number(n);
}
function getDefaultTaxRate_(product){
  const cat = categoriesById[product.category_id];
  if(product.override_tax_rate !== null && product.override_tax_rate !== undefined) return product.override_tax_rate;
  return cat ? cat.default_tax_rate : 0.10;
}
function getDefaultFxToTwd_(product, currency){
  const cat = categoriesById[product.category_id];
  if(product.override_fx_to_twd !== null && product.override_fx_to_twd !== undefined) return product.override_fx_to_twd;
  if(cat && cat.default_fx_to_twd && String(currency).toUpperCase()==="JPY") return cat.default_fx_to_twd;
  return getFxToTwd_(currency);
}

function renderList(){
  const wrap = document.getElementById("listWrap");
  if(!wrap) return;
  wrap.innerHTML = "";

  const q = (document.getElementById("q").value||"").trim().toLowerCase();
  const activeProducts = Object.values(productsById).filter(p=>p.active !== false);

  const filtered = activeProducts.filter(p=>{
    if(filterCountry === "all") return true;
    const catStores = (storesByCat[p.category_id] || []);
    const has = catStores.some(st=>{
      if(st.country_code !== filterCountry) return false;
      return ["LIST","TAXED","UNTAXED"].some(pt => pricesByKey[`${p.product_id}|${st.store_id}|${pt}`]?.amount !== "");
    });
    return has;
  });

  const groups = {};
  filtered.forEach(p=>{
    const cid = p.category_id || "uncat";
    if(!groups[cid]) groups[cid] = [];
    groups[cid].push(p);
  });

  const catIds = Object.keys(groups).sort((a,b)=>{
    const ca = categoriesById[a], cb = categoriesById[b];
    const oa = ca?.sort_order ?? 9999;
    const ob = cb?.sort_order ?? 9999;
    if(oa !== ob) return oa - ob;
    return String(ca?.name||a).localeCompare(String(cb?.name||b), "zh-Hant");
  });

  function passSearch_(p){
    if(!q) return true;
    const catName = categoriesById[p.category_id]?.name || "";
    const storeNames = (storesByCat[p.category_id]||[]).map(s=>s.store_name).join(" ");
    const best = Math.min(scoreMatch(p.name,q), scoreMatch(catName,q)+200, scoreMatch(storeNames,q)+400);
    return best < 999999;
  }

  let any = false;
  catIds.forEach(cid=>{
    const cat = categoriesById[cid] || {name: cid, color:""};
    const list = groups[cid].filter(passSearch_);
    if(!list.length) return;

    any = true;
    list.sort((a,b)=>{
      const ka = productSortKey_(a.name), kb = productSortKey_(b.name);
      if(ka.len !== kb.len) return ka.len - kb.len;
      if(ka.type !== kb.type) return ka.type - kb.type;
      return ka.text.localeCompare(kb.text, "zh-Hant");
    });

    const block = document.createElement("div");
    block.className = "catBlock";
    block.style.background = cat.color || "#f7f7ff";
    block.style.border = "1px solid #eef0f6";

    const head = document.createElement("div");
    head.className = "catHeader";
    head.innerHTML = `<div class="catName">${escapeHtml(cat.name)}</div><div class="small">${list.length} å€‹</div>`;
    block.appendChild(head);

    const listWrap = document.createElement("div");
    listWrap.className = "list";

    list.forEach(p=>{
      const catStores = storesByCat[p.category_id] || [];
      const twStores = catStores.filter(s=>s.country_code==="TW");
      const jpStores = catStores.filter(s=>s.country_code==="JP");

      const twVals = twStores.map(s=>pricesByKey[`${p.product_id}|${s.store_id}|LIST`]?.amount).filter(v=>v!=="" && v!=null).map(Number);
      const twMin = twVals.length ? Math.min(...twVals) : null;

      const jpAmounts = [];
      jpStores.forEach(s=>{
        ["TAXED","UNTAXED"].forEach(pt=>{
          const v = pricesByKey[`${p.product_id}|${s.store_id}|${pt}`]?.amount;
          if(v!=="" && v!=null) jpAmounts.push({amount:Number(v), currency:s.currency||"JPY"});
        });
      });
      let jpMinTwd = null;
      if(jpAmounts.length){
        const converted = jpAmounts.map(x=>{
          const fx = getDefaultFxToTwd_(p, x.currency);
          return (fx ? Math.round(x.amount * fx) : null);
        }).filter(v=>v!=null);
        jpMinTwd = converted.length ? Math.min(...converted) : null;
      }

      const item = document.createElement("div");
      item.className = "item";
      item.onclick = ()=>openDetail(p.product_id);

      const th = document.createElement("div");
      th.className = "thumb";
      if(p.photo_url){
        const img=document.createElement("img");
        img.src=p.photo_url;
        th.appendChild(img);
      } else th.textContent="Photo";

      const mid = document.createElement("div");
      mid.style.flex="1";

      const nm = document.createElement("div");
      nm.className="name";
      nm.textContent=p.name;

      const sp = document.createElement("div");
      sp.className="spec";
      sp.textContent=`${p.spec || ""} Â· ${cat.name || "æœªåˆ†é¡"}`;

      const meta = document.createElement("div");
      meta.className="meta";
      meta.innerHTML = `<div class="small">TW:${twStores.length} åº— Â· JP:${jpStores.length} åº—</div><div class="tag">ID ${escapeHtml(p.product_id)}</div>`;

      const sum = document.createElement("div");
      sum.className="sum";
      if(twMin!=null && jpMinTwd==null) sum.innerHTML = `<strong>å°ç£æœ€ä½ NT$ ${twMin}</strong>`;
      else if(twMin==null && jpMinTwd!=null) sum.innerHTML = `<strong>æ—¥æœ¬ç´„ NT$ ${jpMinTwd}</strong>`;
      else if(twMin!=null && jpMinTwd!=null) sum.innerHTML = `<strong>å°ç£ NT$ ${twMin} / æ—¥æœ¬ç´„ NT$ ${jpMinTwd}</strong>`;
      else sum.textContent = "å°šæœªè¼¸å…¥åƒ¹æ ¼";

      mid.appendChild(nm);
      mid.appendChild(sp);
      mid.appendChild(meta);
      mid.appendChild(sum);

      item.appendChild(th);
      item.appendChild(mid);
      listWrap.appendChild(item);
    });

    block.appendChild(listWrap);
    wrap.appendChild(block);
  });

  if(!any){
    const e = document.createElement("div");
    e.className="small";
    e.style.margin="12px 2px";
    e.textContent = q ? "æ‰¾ä¸åˆ°ç¬¦åˆçš„å•†å“" : "ç›®å‰æ²’æœ‰è³‡æ–™ï¼ˆè«‹åˆ°è¨­å®šè¼‰å…¥ Google Sheetsï¼‰";
    wrap.appendChild(e);
  }
}

function closeDetail(){
  document.getElementById("bd").classList.remove("active");
  currentDetailProductId = null;
  setDetailMsg("");
}
document.getElementById("bd").addEventListener("click", (e)=>{ if(e.target.id==="bd") closeDetail(); });

function setDetailMsg(msg, isErr=false){
  const el = document.getElementById("d_msg");
  if(!el) return;
  el.textContent = msg || "";
  el.className = "msg " + (msg ? (isErr?"err":"ok") : "");
}

function getDetailOverrides_(){
  const tax = normalizeTaxRate_(document.getElementById("ov_tax")?.value, 0.10);
  const fxj = cleanNumber_(document.getElementById("ov_fx_jpy")?.value);
  return { tax, fx_jpy: fxj==="" ? null : Number(fxj) };
}
function calcUntaxedFromTax_(taxed, taxRate){
  const t = cleanNumber_(taxed);
  if(t === "") return "";
  const rate = normalizeTaxRate_(taxRate, 0.10);
  return Math.round(Number(t) / (1 + rate));
}
function calcTaxFromUntaxed_(untaxed, taxRate){
  const u = cleanNumber_(untaxed);
  if(u === "") return "";
  const rate = normalizeTaxRate_(taxRate, 0.10);
  return Math.round(Number(u) * (1 + rate));
}
function bindJpAutoCalc_(){
  const taxEl = document.getElementById("ov_tax");
  const syncAll = ()=>{
    const tax = normalizeTaxRate_(taxEl?.value, 0.10);
    document.querySelectorAll(".dc_price_jp_taxed").forEach(t=>{
      const sid = t.getAttribute("data-store-id");
      const u = document.querySelector(`.dc_price_jp_untaxed[data-store-id="${CSS.escape(sid)}"]`);
      if(!u) return;
      const tv = cleanNumber_(t.value);
      const uv = cleanNumber_(u.value);
      if(tv !== "") u.value = String(calcUntaxedFromTax_(tv, tax));
      else if(uv !== "") t.value = String(calcTaxFromUntaxed_(uv, tax));
    });
  };

  document.querySelectorAll(".dc_price_jp_taxed").forEach(inp=>{
    inp.addEventListener("input", ()=>{
      const tax = normalizeTaxRate_(taxEl?.value, 0.10);
      const sid = inp.getAttribute("data-store-id");
      const u = document.querySelector(`.dc_price_jp_untaxed[data-store-id="${CSS.escape(sid)}"]`);
      if(!u) return;
      const val = calcUntaxedFromTax_(inp.value, tax);
      if(val !== "") u.value = String(val);
    });
  });
  document.querySelectorAll(".dc_price_jp_untaxed").forEach(inp=>{
    inp.addEventListener("input", ()=>{
      const tax = normalizeTaxRate_(taxEl?.value, 0.10);
      const sid = inp.getAttribute("data-store-id");
      const t = document.querySelector(`.dc_price_jp_taxed[data-store-id="${CSS.escape(sid)}"]`);
      if(!t) return;
      const val = calcTaxFromUntaxed_(inp.value, tax);
      if(val !== "") t.value = String(val);
    });
  });
  if(taxEl) taxEl.addEventListener("input", syncAll);
}

function openDetail(productId){
  const p = productsById[productId];
  if(!p) return;

  currentDetailProductId = productId;
  const cat = categoriesById[p.category_id] || {name:"æœªåˆ†é¡"};
  document.getElementById("d_title").textContent = p.name;
  document.getElementById("d_sub").textContent = `${p.spec || ""} Â· ${cat.name || ""} Â· å•†å“ID ${p.product_id}`;

  const blocks = document.getElementById("d_blocks");
  blocks.innerHTML = "";

  const defaultTax = getDefaultTaxRate_(p);
  blocks.innerHTML += `
    <div class="block">
      <div class="bt">æœ¬æ¬¡é¡¯ç¤ºè¦†å¯«ï¼ˆä¸å¯«å›ï¼‰</div>
      <div class="grid2">
        <input id="ov_tax" class="inp" placeholder="ç¨…ç‡ï¼ˆå¦‚ 0.1 æˆ– 10ï¼‰" value="${escapeHtml(defaultTax)}"/>
        <input id="ov_fx_jpy" class="inp" placeholder="JPYâ†’TWD åŒ¯ç‡ï¼ˆå¦‚ 0.2032ï¼Œå¯ç©ºï¼‰" value="${escapeHtml(getDefaultFxToTwd_(p,'JPY') ?? '')}"/>
      </div>
      <div class="small" style="margin-top:6px;">ç¨…ç‡ç”¨æ–¼æ—¥æœ¬æœªç¨…/å«ç¨…äº’ç®—ï¼›åŒ¯ç‡ç”¨æ–¼é¡¯ç¤ºã€Œç´„ NT$ã€ã€‚</div>
    </div>
  `;

  const catStores = (storesByCat[p.category_id] || []);
  const countries = [...new Set(catStores.map(s=>s.country_code).filter(Boolean))].sort();

  countries.forEach(cc=>{
    const storeList = catStores.filter(s=>s.country_code===cc);
    const block = document.createElement("div");
    block.className="block";
    block.innerHTML = `<div class="bt">${escapeHtml(cc)}ï¼ˆ${storeList.length} å®¶ï¼‰</div>`;

    storeList.forEach(st=>{
      const cur = st.currency || "";
      const keyList = `${p.product_id}|${st.store_id}|LIST`;
      const keyUntaxed = `${p.product_id}|${st.store_id}|UNTAXED`;
      const keyTaxed = `${p.product_id}|${st.store_id}|TAXED`;

      const listVal = pricesByKey[keyList]?.amount ?? "";
      const untaxedVal = pricesByKey[keyUntaxed]?.amount ?? "";
      const taxedVal = pricesByKey[keyTaxed]?.amount ?? "";

      const row = document.createElement("div");
      row.style.marginBottom="10px";
      row.innerHTML = `
        <div class="sr">
          <div>
            <div class="sn">${escapeHtml(st.store_name)}</div>
            <div class="note">${escapeHtml(st.store_id)} Â· ${escapeHtml(cur)}</div>
          </div>
          <div class="small">${escapeHtml(cc)}</div>
        </div>
      `;

      const fx = getDefaultFxToTwd_(p, cur);

      if(cc === "JP"){
        row.innerHTML += `
          <div class="grid2">
            <input class="inp dc_price_jp_untaxed" data-store-id="${escapeHtml(st.store_id)}" placeholder="æœªç¨…ï¼ˆUNTAXEDï¼‰" value="${escapeHtml(untaxedVal)}" inputmode="decimal"/>
            <input class="inp dc_price_jp_taxed" data-store-id="${escapeHtml(st.store_id)}" placeholder="å«ç¨…ï¼ˆTAXEDï¼‰" value="${escapeHtml(taxedVal)}" inputmode="decimal"/>
          </div>
          <div class="small" style="margin-top:6px;">${fx ? `åŒ¯ç‡ ${cur}â†’TWDï¼š${fx}` : `æœªè¨­å®šåŒ¯ç‡ ${cur}â†’TWDï¼ˆå¯åœ¨ fx_rates è¨­å®šï¼‰`}</div>
        `;
      } else {
        row.innerHTML += `
          <input class="inp dc_price_list" data-store-id="${escapeHtml(st.store_id)}" placeholder="åƒ¹æ ¼ï¼ˆLISTï¼‰" value="${escapeHtml(listVal)}" inputmode="decimal"/>
          <div class="small" style="margin-top:6px;">${fx ? `åŒ¯ç‡ ${cur}â†’TWDï¼š${fx}` : (cur==="TWD" ? "" : `æœªè¨­å®šåŒ¯ç‡ ${cur}â†’TWD`)}</div>
        `;
      }
      block.appendChild(row);
    });

    blocks.appendChild(block);
  });

  bindJpAutoCalc_();
  document.getElementById("bd").classList.add("active");
  setDetailMsg("");
}

function apiGetConfig_(){
  const url = (localStorage.getItem(KEY_API_URL) || "").trim();
  const token = (localStorage.getItem(KEY_API_TOKEN) || "").trim();
  return {url, token};
}
function apiJsonp(action, data){
  return new Promise((resolve, reject)=>{
    const {url, token} = apiGetConfig_();
    if(!url) return reject(new Error("å°šæœªè¨­å®š Web App URLï¼ˆè¨­å®šé ï¼‰"));
    if(!token) return reject(new Error("å°šæœªè¨­å®š tokenï¼ˆè¨­å®šé ï¼‰"));

    const cb = "dc5_cb_" + Math.random().toString(36).slice(2);
    let script = null;

    window[cb] = (resp)=>{
      try{
        if(!resp || resp.ok !== true) throw new Error(resp?.error || "API å¤±æ•—");
        resolve(resp);
      }catch(e){
        reject(e);
      }finally{
        try{ delete window[cb]; }catch(_){}
        if(script) script.remove();
      }
    };

    const qs =
      `action=${encodeURIComponent(action)}` +
      `&token=${encodeURIComponent(token)}` +
      `&callback=${encodeURIComponent(cb)}` +
      `&data=${encodeURIComponent(JSON.stringify(data||{}))}`;

    script = document.createElement("script");
    script.src = url + (url.includes("?") ? "&" : "?") + qs;
    script.onerror = ()=>{
      reject(new Error("JSONP è¼‰å…¥å¤±æ•—ï¼ˆéƒ¨ç½²/æ¬Šé™/token/URL å¯èƒ½éŒ¯ï¼‰"));
      try{ delete window[cb]; }catch(_){}
      if(script) script.remove();
    };
    document.body.appendChild(script);
  });
}

async function saveDetail(){
  try{
    if(currentDetailProductId === "__NEW__"){
      await saveNewProduct_();
      return;
    }
    if(!currentDetailProductId) return;
    const pid = currentDetailProductId;
    const p = productsById[pid];
    if(!p) throw new Error("æ‰¾ä¸åˆ°å•†å“");

    setDetailMsg("å„²å­˜ä¸­â€¦");
    const {tax} = getDetailOverrides_();
    const tasks = [];

    document.querySelectorAll(".dc_price_list").forEach(inp=>{
      const sid = inp.getAttribute("data-store-id");
      const amount = cleanNumber_(inp.value);
      const pt = "LIST";
      const key = `${pid}|${sid}|${pt}`;
      const payload = { price_id:key, product_id:pid, store_id:sid, price_type:pt, amount: amount==="" ? "" : Number(amount) };
      tasks.push(apiJsonp("upsertPrice", payload));
    });

    document.querySelectorAll(".dc_price_jp_untaxed").forEach(inp=>{
      const sid = inp.getAttribute("data-store-id");
      const u = cleanNumber_(inp.value);
      const tEl = document.querySelector(`.dc_price_jp_taxed[data-store-id="${CSS.escape(sid)}"]`);
      const t = tEl ? cleanNumber_(tEl.value) : "";

      let untaxed = u, taxed = t;
      if(taxed !== "" && untaxed === "") untaxed = calcUntaxedFromTax_(taxed, tax);
      if(untaxed !== "" && taxed === "") taxed = calcTaxFromUntaxed_(untaxed, tax);

      const payloadU = { price_id:`${pid}|${sid}|UNTAXED`, product_id:pid, store_id:sid, price_type:"UNTAXED", amount: untaxed==="" ? "" : Number(untaxed), tax_rate: tax };
      const payloadT = { price_id:`${pid}|${sid}|TAXED`, product_id:pid, store_id:sid, price_type:"TAXED", amount: taxed==="" ? "" : Number(taxed), tax_rate: tax };
      tasks.push(apiJsonp("upsertPrice", payloadU));
      tasks.push(apiJsonp("upsertPrice", payloadT));
    });

    if(!tasks.length) throw new Error("æ²’æœ‰å¯å„²å­˜çš„æ¬„ä½");
    await Promise.all(tasks);

    setDetailMsg("å·²å„²å­˜ã€‚é‡æ–°è¼‰å…¥è³‡æ–™â€¦");
    await loadAll();
    openDetail(pid);
    setDetailMsg("å·²æ›´æ–°ã€‚");
  }catch(err){
    console.error(err);
    setDetailMsg("å„²å­˜å¤±æ•—ï¼š" + (err.message || err), true);
  }
}

function nextProductId_(){
  const ids = Object.keys(productsById||{}).map(x=>parseInt(x,10)).filter(n=>!isNaN(n));
  const maxId = ids.length ? Math.max(...ids) : 0;
  return String(maxId + 1);
}
function openAddProduct(){
  if(!Object.keys(categoriesById||{}).length){
    alert("è«‹å…ˆåˆ°ã€Œè¨­å®šã€è¼‰å…¥è³‡æ–™ã€‚");
    return;
  }
  currentDetailProductId = "__NEW__";

  document.getElementById("d_title").textContent = "æ–°å¢å•†å“";
  document.getElementById("d_sub").textContent = "å¡«å®ŒæŒ‰ã€Œå„²å­˜ï¼ˆå¯«å› Sheetsï¼‰ã€ã€‚";

  const catOptions = Object.values(categoriesById).sort((a,b)=>String(a.name).localeCompare(String(b.name),"zh-Hant"))
    .map(c=>`<option value="${escapeHtml(c.id)}">${escapeHtml(c.name)} (${escapeHtml(c.id)})</option>`).join("");

  const pid = nextProductId_();
  document.getElementById("d_blocks").innerHTML = `
    <div class="block">
      <div class="bt">å•†å“åŸºæœ¬è³‡æ–™</div>
      <div style="display:grid;gap:8px;">
        <div class="small">product_idï¼ˆå¯æ”¹ï¼Œä½†éœ€å”¯ä¸€ï¼‰</div>
        <input id="np_pid" class="inp" value="${escapeHtml(pid)}"/>
        <input id="np_name" class="inp" placeholder="å•†å“åç¨±ï¼ˆå¿…å¡«ï¼‰"/>
        <input id="np_spec" class="inp" placeholder="è¦æ ¼ï¼ˆå¯ç©ºï¼Œä¾‹å¦‚ 50mlï¼‰"/>
        <select id="np_cat" class="sel">
          <option value="">é¸æ“‡é¡åˆ¥ï¼ˆå¿…å¡«ï¼‰</option>
          ${catOptions}
        </select>
        <input id="np_photo" class="inp" placeholder="åœ–ç‰‡ URLï¼ˆå¯ç©ºï¼‰"/>
      </div>
    </div>
  `;
  document.getElementById("bd").classList.add("active");
  setDetailMsg("");
}

async function saveNewProduct_(){
  try{
    const pid = (document.getElementById("np_pid")?.value || "").trim();
    const name = (document.getElementById("np_name")?.value || "").trim();
    const spec = (document.getElementById("np_spec")?.value || "").trim();
    const cid = (document.getElementById("np_cat")?.value || "").trim();
    const photo = (document.getElementById("np_photo")?.value || "").trim();

    if(!pid) throw new Error("product_id å¿…å¡«");
    if(!name) throw new Error("å•†å“åç¨±å¿…å¡«");
    if(!cid) throw new Error("é¡åˆ¥å¿…å¡«");

    setDetailMsg("æ–°å¢å•†å“ä¸­â€¦");
    const payload = { product_id:pid, name, spec, category_id:cid, photo_url:photo, active:"TRUE" };
    await apiJsonp("upsertProduct", payload);

    setDetailMsg("å·²æ–°å¢ã€‚é‡æ–°è¼‰å…¥â€¦");
    await loadAll();
    closeDetail();
    openDetail(pid);
    setDetailMsg("å·²æ–°å¢å®Œæˆã€‚");
  }catch(err){
    console.error(err);
    setDetailMsg("æ–°å¢å¤±æ•—ï¼š" + (err.message || err), true);
  }
}

function setAdminMsg(id, msg, err=false){
  const el = document.getElementById(id);
  if(!el) return;
  el.textContent = msg || "";
  el.className = "msg " + (msg ? (err?"err":"ok") : "");
}
async function adminSaveCategory(){
  try{
    const payload = {
      category_id: (document.getElementById("cat_id").value||"").trim(),
      category_name: (document.getElementById("cat_name").value||"").trim(),
      color: (document.getElementById("cat_color").value||"").trim(),
      sort_order: (document.getElementById("cat_order").value||"").trim(),
      default_tax_rate: (document.getElementById("cat_tax").value||"").trim(),
      default_fx_to_twd: (document.getElementById("cat_fx").value||"").trim(),
    };
    if(!payload.category_id) throw new Error("category_id å¿…å¡«");
    setAdminMsg("adminMsg","å„²å­˜ä¸­â€¦");
    await apiJsonp("upsertCategory", payload);
    setAdminMsg("adminMsg","å·²å„²å­˜ã€‚é‡æ–°è¼‰å…¥â€¦");
    await loadAll();
    setAdminMsg("adminMsg","å®Œæˆã€‚");
  }catch(err){
    console.error(err);
    setAdminMsg("adminMsg","å¤±æ•—ï¼š" + (err.message||err), true);
  }
}
async function adminSaveFx(){
  try{
    const payload = {
      pair: (document.getElementById("fx_pair").value||"").trim(),
      rate: (document.getElementById("fx_rate").value||"").trim(),
      source: "manual"
    };
    if(!payload.pair) throw new Error("pair å¿…å¡«");
    if(payload.rate==="" || !isFinite(Number(payload.rate))) throw new Error("rate å¿…é ˆæ˜¯æ•¸å­—");
    setAdminMsg("fxMsg","å„²å­˜ä¸­â€¦");
    await apiJsonp("upsertFx", payload);
    setAdminMsg("fxMsg","å·²å„²å­˜ã€‚é‡æ–°è¼‰å…¥â€¦");
    await loadAll();
    setAdminMsg("fxMsg","å®Œæˆã€‚");
  }catch(err){
    console.error(err);
    setAdminMsg("fxMsg","å¤±æ•—ï¼š" + (err.message||err), true);
  }
}

function saveSheetId(){
  const v = (document.getElementById("sheetInput").value||"").trim();
  if(!v){ alert("è«‹è²¼ä¸Šè©¦ç®—è¡¨ç¶²å€æˆ– Sheet ID"); return; }
  localStorage.setItem(KEY_SHEET, v);
  updateSourceInfo();
  alert("å·²å„²å­˜ã€‚å»ºè­°æŒ‰ã€Œè¼‰å…¥è³‡æ–™ã€æ¸¬è©¦ã€‚");
}
function saveApi(){
  const url = (document.getElementById("apiUrlInput").value||"").trim();
  const token = (document.getElementById("apiTokenInput").value||"").trim();
  if(url) localStorage.setItem(KEY_API_URL, url);
  if(token) localStorage.setItem(KEY_API_TOKEN, token);
  alert("å·²å„²å­˜ Web App URL / token");
}
function updateSourceInfo(usingCache=false){
  const raw = localStorage.getItem(KEY_SHEET) || "";
  const id = extractSheetId(raw);
  const el = document.getElementById("sourceInfo");
  if(el){
    el.textContent = id ? `ç›®å‰ Sheet IDï¼š${id}${usingCache?"ï¼ˆé¡¯ç¤ºå¿«å–ï¼‰":""}` : "å°šæœªè¨­å®šã€‚è«‹åˆ°ã€Œè¨­å®šã€è²¼ä¸Šè©¦ç®—è¡¨ç¶²å€æˆ– Sheet IDã€‚";
  }
  const si = document.getElementById("sheetInput");
  if(si) si.value = raw;

  const au = document.getElementById("apiUrlInput");
  const at = document.getElementById("apiTokenInput");
  if(au) au.value = localStorage.getItem(KEY_API_URL) || "";
  if(at) at.value = localStorage.getItem(KEY_API_TOKEN) || "";
}

updateSourceInfo();

const cache = localStorage.getItem(KEY_CACHE);
if(cache){
  try{
    const data = JSON.parse(cache);
    categories = data.categories||[];
    stores = data.stores||[];
    products = data.products||[];
    prices = data.prices||[];
    fxRates = data.fxRates||[];
    buildModel();
    renderList();
  }catch(_){}
}

window.addEventListener("load", ()=>{
  const bd = document.getElementById("bd");
  if(bd) bd.classList.remove("active");
});
</script>
</body>
</html>
