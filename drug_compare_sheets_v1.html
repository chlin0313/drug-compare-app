<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>DrugCompare â€“ è®€å– Google Sheets</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{--p:#6554f6;--pl:#ebe9ff;--bg:#f5f5fb;--t:#1f2933;--s:#7b8794;}
    *{box-sizing:border-box}
    body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",system-ui,sans-serif;background:var(--bg);color:var(--t)}
    .app{max-width:520px;margin:0 auto;min-height:100vh;background:#fff;box-shadow:0 0 30px rgba(0,0,0,.06)}
    header{padding:14px 18px 8px;position:sticky;top:0;background:#fff;z-index:9}
    .brand{font-weight:800;color:var(--p);font-size:18px}
    .brand span{font-weight:500;color:var(--s);font-size:12px;margin-left:6px}
    main{padding:0 14px 70px;background:linear-gradient(180deg,#f5f5fb 0%,#fff 40%)}
    .screen{display:none;animation:in .18s ease-out}
    .screen.active{display:block}
    @keyframes in{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:translateY(0)}}
    .title{font-size:18px;font-weight:700;margin:8px 0 10px}
    .card{background:#fff;border-radius:16px;padding:12px;box-shadow:0 8px 18px rgba(15,23,42,.08);margin-bottom:10px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .btn{border:none;border-radius:999px;padding:8px 12px;background:var(--p);color:#fff;font-size:13px;cursor:pointer}
    .btn.secondary{background:#e5e7eb;color:#374151}
    .inp{width:100%;border:1px solid #e5e7eb;border-radius:12px;padding:10px 12px;background:#fff;font-size:14px;outline:none}
    .small{font-size:12px;color:var(--s);line-height:1.4}
    .pill{display:inline-flex;background:#eef2ff;border-radius:999px;padding:4px}
    .pill button{border:none;background:transparent;border-radius:999px;padding:7px 12px;font-size:12px;color:var(--s);cursor:pointer}
    .pill button.active{background:#fff;color:var(--p);box-shadow:0 4px 10px rgba(101,84,246,.25)}
    .list{display:flex;flex-direction:column;gap:10px}
    .item{display:flex;gap:12px;align-items:flex-start;background:#fff;border-radius:16px;padding:10px;box-shadow:0 6px 14px rgba(15,23,42,.1);cursor:pointer}
    .thumb{width:56px;height:56px;border-radius:16px;background:#e5e7f5;overflow:hidden;display:flex;align-items:center;justify-content:center;font-size:11px;color:var(--s);flex:0 0 auto}
    .thumb img{width:100%;height:100%;object-fit:cover}
    .name{font-size:14px;font-weight:700;margin-bottom:2px}
    .spec{font-size:11px;color:var(--s);margin-bottom:6px}
    .meta{display:flex;justify-content:space-between;align-items:center;margin-bottom:2px}
    .tag{font-size:10px;padding:2px 8px;border-radius:999px;background:#f3f4ff;color:var(--p)}
    .sum{font-size:11px;color:var(--s)}
    .sum strong{font-size:13px;color:var(--p)}
    .nav{position:fixed;left:50%;bottom:0;transform:translateX(-50%);width:100%;max-width:520px;background:#fff;border-top:1px solid #e0e5f2;padding:6px 22px 10px;display:flex}
    .nav .n{flex:1;text-align:center;font-size:10px;color:var(--s);cursor:pointer}
    .nav .i{width:22px;height:22px;border-radius:999px;margin:0 auto 2px;display:flex;align-items:center;justify-content:center;font-size:13px;color:var(--s)}
    .nav .n.active{color:var(--p)}
    .nav .n.active .i{background:var(--p);color:#fff}
    /* bottom sheet */
    .backdrop{position:fixed;inset:0;background:rgba(15,23,42,.45);display:none;align-items:flex-end;justify-content:center;z-index:50}
    .backdrop.active{display:flex}
    .sheet{width:100%;max-width:520px;background:#fff;border-radius:20px 20px 0 0;padding:12px 14px 16px;max-height:82vh;overflow:auto;box-shadow:0 -6px 18px rgba(0,0,0,.25)}
    .handle{width:36px;height:4px;border-radius:999px;background:#e5e7eb;margin:0 auto 10px}
    .sheet h3{margin:0 0 4px;font-size:16px}
    .sheet .sub{font-size:12px;color:var(--s);margin-bottom:10px}
    .block{background:#f9fafb;border-radius:14px;padding:10px;margin-bottom:10px}
    .block .bt{font-weight:700;font-size:13px;margin-bottom:6px}
    .sr{display:flex;justify-content:space-between;gap:12px;margin-bottom:6px}
    .sn{font-weight:600}
    .note{font-size:11px;color:var(--s)}
    .line{font-size:12px}
  </style>
</head>
<body>
<div class="app">
  <header>
    <div class="brand">DrugCompare <span>Google Sheets ç‰ˆ</span></div>
  </header>

  <main>
    <!-- Home -->
    <section id="home" class="screen active">
      <div class="title">é¦–é </div>

      <div class="card">
        <div style="font-weight:700;margin-bottom:6px;">è³‡æ–™ä¾†æºï¼ˆGoogle Sheetsï¼‰</div>
        <div class="small" id="sourceInfo">å°šæœªè¨­å®šã€‚è«‹åˆ°ã€Œè¨­å®šã€è²¼ä¸Šè©¦ç®—è¡¨ç¶²å€æˆ– Sheet IDã€‚</div>
        <div class="row" style="margin-top:10px;">
          <button class="btn" onclick="openList('all')">æŸ¥çœ‹å•†å“</button>
          <button class="btn secondary" onclick="openSettings()">è¨­å®š</button>
        </div>
      </div>

      <div class="card">
        <div style="font-weight:700;margin-bottom:6px;">å¿«é€Ÿèªªæ˜</div>
        <div class="small">
          1) ä½ çš„è©¦ç®—è¡¨éœ€æœ‰ä¸‰å€‹åˆ†é ï¼šcategories / stores / productsã€‚<br/>
          2) å…±äº«æ¬Šé™éœ€å…è¨±ä»»ä½•æœ‰é€£çµçš„äººæª¢è¦–ï¼ˆæˆ–ç™¼ä½ˆåˆ°ç¶²è·¯ï¼‰ã€‚<br/>
          3) App æœƒè‡ªå‹•ç”¨ã€Œé¡åˆ¥ã€çš„åŒ¯ç‡èˆ‡ç¨…ç‡è¨ˆç®—æ—¥æœ¬åƒ¹æ ¼æ›ç®—ã€‚
        </div>
      </div>
    </section>

    <!-- List -->
    <section id="list" class="screen">
      <div class="row" style="margin-top:8px;justify-content:space-between;">
        <div style="font-weight:800;font-size:18px;">å•†å“</div>
        <div class="pill">
          <button id="f_all" class="active" onclick="setFilter('all')">å…¨éƒ¨</button>
          <button id="f_tw" onclick="setFilter('tw')">å°ç£</button>
          <button id="f_jp" onclick="setFilter('jp')">æ—¥æœ¬</button>
        </div>
      </div>

      <input id="q" class="inp" style="margin-top:10px" placeholder="æœå°‹å•†å“ / é¡åˆ¥ / åº—å®¶ï¼ˆæ”¯æ´æ’åºï¼‰" oninput="renderList()" />
      <div class="small" style="margin:6px 2px 10px;">
        æœå°‹æ’åºï¼šå®Œå…¨ç›¸ç¬¦ ï¼ é–‹é ­ç›¸ç¬¦ ï¼ ä¸­æ®µç›¸ç¬¦ ï¼ é¡åˆ¥/åº—å®¶å‘½ä¸­ã€‚è³‡æ–™é‡ 50+ ä¹Ÿé©ç”¨ã€‚
      </div>

      <div id="listWrap" class="list"></div>
    </section>

    <!-- Settings -->
    <section id="settings" class="screen">
      <div class="title">è¨­å®š</div>

      <div class="card">
        <div style="font-weight:700;margin-bottom:6px;">è©¦ç®—è¡¨ç¶²å€æˆ– Sheet ID</div>
        <input id="sheetInput" class="inp" placeholder="è²¼ä¸Šæ•´å€‹ Google Sheets ç¶²å€ï¼Œæˆ–è²¼ Sheet IDï¼ˆé‚£ä¸²è‹±æ–‡æ•¸å­—ï¼‰" />
        <div class="small" style="margin-top:6px;">
          Sheet ID åœ¨ç¶²å€ä¸­ï¼š<br/>
          https://docs.google.com/spreadsheets/d/<b>é€™ä¸€ä¸²</b>/edit
        </div>
        <div class="row" style="margin-top:10px;">
          <button class="btn" onclick="saveSheetId()">å„²å­˜</button>
          <button class="btn secondary" onclick="loadFromSheets()">è¼‰å…¥è³‡æ–™</button>
        </div>
        <div class="small" id="loadStatus" style="margin-top:8px;"></div>
      </div>

      <div class="card">
        <div style="font-weight:700;margin-bottom:6px;">è‹¥è¼‰å…¥å¤±æ•—ï¼Œæœ€å¸¸è¦‹åŸå› </div>
        <div class="small">
          1) è©¦ç®—è¡¨æœªè¨­ç‚ºã€ŒçŸ¥é“é€£çµçš„äººå¯æª¢è¦–ã€ã€‚<br/>
          2) åˆ†é åç¨±ä¸æ˜¯ categories / stores / productsï¼ˆå¤§å°å¯«ä¸ç¬¦ä¹Ÿæœƒå¤±æ•—ï¼‰ã€‚<br/>
          3) æ¬„ä½è¡¨é ­æ‹¼å­—ä¸åŒï¼ˆéœ€èˆ‡ç¯„æœ¬ä¸€è‡´ï¼‰ã€‚
        </div>
      </div>

      <div class="card">
        <div style="font-weight:700;margin-bottom:6px;">å¿«å–</div>
        <div class="small">ç‚ºäº†é›¢ç·šä»å¯çœ‹è³‡æ–™ï¼ŒApp æœƒä¿ç•™ä¸Šæ¬¡æˆåŠŸè¼‰å…¥çš„å¿«å–ã€‚</div>
        <div class="row" style="margin-top:10px;">
          <button class="btn secondary" onclick="clearCache()">æ¸…é™¤å¿«å–</button>
        </div>
      </div>
    </section>
  </main>

  <nav class="nav">
    <div class="n active" id="nav_home" onclick="go('home')"><div class="i">ğŸ </div>é¦–é </div>
    <div class="n" id="nav_list" onclick="openList('all')"><div class="i">ğŸ“‹</div>å•†å“</div>
    <div class="n" id="nav_set" onclick="openSettings()"><div class="i">âš™ï¸</div>è¨­å®š</div>
  </nav>
</div>

<div id="bd" class="backdrop">
  <div class="sheet">
    <div class="handle"></div>
    <h3 id="d_title"></h3>
    <div class="sub" id="d_sub"></div>
    <div id="d_blocks"></div>
    <button class="btn" style="width:100%;margin-top:6px" onclick="closeDetail()">é—œé–‰</button>
  </div>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbyg0NTDkOmZkXFr2MsTlj3rOOgao202hU9gWb27SapaBFTdVLKoanR6OrL5ac7eIeiKZA/exec";
const API_TOKEN = "313703yiYI~";

async function apiPost(action, data){
  const res = await fetch(API_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ action, token: API_TOKEN, data })
  });
  const json = await res.json();
  if(!json.ok) throw new Error(json.error || "API å¤±æ•—");
  return json;
}


  // -------------------- Storage keys --------------------
  const KEY_SHEET = "dc_sheet_id_or_url_v1";
  const KEY_CACHE = "dc_cache_v1";

  // -------------------- State --------------------
  let filter = "all";
  let categoriesById = {};
  let stores = [];                // raw rows
  let storesByKey = {};           // key: country|category_id -> list
  let products = [];              // aggregated products for UI

  // -------------------- Utilities --------------------
  function show(id){
    document.querySelectorAll(".screen").forEach(s=>s.classList.remove("active"));
    document.getElementById(id).classList.add("active");
    document.getElementById("nav_home").classList.toggle("active", id==="home");
    document.getElementById("nav_list").classList.toggle("active", id==="list");
    document.getElementById("nav_set").classList.toggle("active", id==="settings");
  }
  function go(id){ show(id); }
  function openSettings(){ show("settings"); }
  function openList(f){ filter=f||"all"; show("list"); setFilter(filter); renderList(); }
  function setFilter(f){
    filter=f;
    ["all","tw","jp"].forEach(k=>{
      document.getElementById("f_"+k).classList.toggle("active", k===filter);
    });
    renderList();
  }
  function closeDetail(){ document.getElementById("bd").classList.remove("active"); }
  document.getElementById("bd").addEventListener("click", (e)=>{ if(e.target.id==="bd") closeDetail(); });

  function extractSheetId(input){
    const t = (input||"").trim();
    if(!t) return "";
    // If full URL
    const m = t.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
    if(m && m[1]) return m[1];
    // maybe already ID
    return t;
  }

  // Robust CSV parse (handles quotes)
  function parseCsv(text){
    // remove BOM
    if(text.charCodeAt(0) === 0xFEFF) text = text.slice(1);
    const rows = [];
    let row = [];
    let cur = "";
    let inQ = false;
    for(let i=0;i<text.length;i++){
      const ch = text[i];
      const next = text[i+1];

      if(ch === '"'){
        if(inQ && next === '"'){ cur+='"'; i++; }
        else inQ = !inQ;
      } else if(ch === ',' && !inQ){
        row.push(cur); cur="";
      } else if((ch === '\n' || ch === '\r') && !inQ){
        if(ch === '\r' && next === '\n') i++;
        row.push(cur); cur="";
        // skip empty last lines
        const allEmpty = row.every(c => (c||"").trim()==="");
        if(!allEmpty) rows.push(row);
        row = [];
      } else {
        cur += ch;
      }
    }
    row.push(cur);
    const allEmpty = row.every(c => (c||"").trim()==="");
    if(!allEmpty) rows.push(row);
    return rows;
  }

  function rowsToObjects(rows){
    if(!rows.length) return [];
    const header = rows[0].map(h => (h||"").trim());
    const out = [];
    for(let i=1;i<rows.length;i++){
      const r = rows[i];
      const obj = {};
      header.forEach((h,idx)=> obj[h] = (r[idx] ?? "").trim());
      out.push(obj);
    }
    return out;
  }

  function numOrNull(v){
    const n = parseFloat(v);
    return isNaN(n) ? null : n;
  }

  // -------------------- Google Sheets fetch via gviz CSV --------------------
  async function fetchSheetCsv(sheetId, sheetName){
    const url = `https://docs.google.com/spreadsheets/d/${encodeURIComponent(sheetId)}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(sheetName)}`;
    const res = await fetch(url, { cache: "no-store" });
    if(!res.ok) throw new Error(`è®€å– ${sheetName} å¤±æ•—ï¼ˆHTTP ${res.status}ï¼‰`);
    return await res.text();
  }

  async function loadFromSheets(){
    const status = document.getElementById("loadStatus");
    status.textContent = "è¼‰å…¥ä¸­â€¦";
    try{
      const raw = localStorage.getItem(KEY_SHEET) || "";
      const sheetId = extractSheetId(raw);
      if(!sheetId) { status.textContent = "è«‹å…ˆå„²å­˜è©¦ç®—è¡¨ç¶²å€æˆ– Sheet IDã€‚"; return; }

      // Fetch 3 sheets
      const [csvCat, csvStores, csvProd] = await Promise.all([
        fetchSheetCsv(sheetId, "categories"),
        fetchSheetCsv(sheetId, "stores"),
        fetchSheetCsv(sheetId, "products"),
      ]);

      const cats = rowsToObjects(parseCsv(csvCat));
      const st   = rowsToObjects(parseCsv(csvStores));
      const pr   = rowsToObjects(parseCsv(csvProd));

      // Validate minimal headers
      // categories: category_id, category_name, jpy_to_twd, jp_tax_rate
      // stores: store_id, store_name, country, category_id
      // products: product_id, name, spec, category_id, store_id, price_twd, price_jpy_untaxed, price_jpy_tax
      buildDataModel(cats, st, pr);

      // Cache
      localStorage.setItem(KEY_CACHE, JSON.stringify({ cats, st, pr, at: Date.now() }));

      status.textContent = "è¼‰å…¥æˆåŠŸã€‚";
      updateSourceInfo();
      renderList();
      show("list");
    }catch(err){
      console.error(err);
      status.textContent = "è¼‰å…¥å¤±æ•—ï¼š" + err.message + "ã€‚å¯æª¢æŸ¥å…±äº«æ¬Šé™ã€åˆ†é åç¨±ã€è¡¨é ­æ¬„ä½ã€‚";
      // Try fallback cache
      const cache = localStorage.getItem(KEY_CACHE);
      if(cache){
        try{
          const data = JSON.parse(cache);
          buildDataModel(data.cats||[], data.st||[], data.pr||[]);
          status.textContent += "ï¼ˆå·²æ”¹ç”¨ä¸Šæ¬¡å¿«å–è³‡æ–™é¡¯ç¤ºï¼‰";
          updateSourceInfo(true);
          renderList();
        }catch(e){}
      }
    }
  }

  function clearCache(){
    localStorage.removeItem(KEY_CACHE);
    alert("å·²æ¸…é™¤å¿«å–ã€‚");
  }

  function buildDataModel(cats, st, pr){
    // categories
    categoriesById = {};
    cats.forEach(c=>{
      const id = c.category_id;
      if(!id) return;
      categoriesById[id] = {
        id,
        name: c.category_name || id,
        jpy_to_twd: numOrNull(c.jpy_to_twd) ?? 0.2032,
        jp_tax_rate: numOrNull(c.jp_tax_rate) ?? 0.10
      };
    });

    // stores registry
    stores = st.map(r=>({
      store_id: r.store_id,
      store_name: r.store_name || r.store_id,
      country: (r.country||"").toUpperCase(),
      category_id: r.category_id
    })).filter(x=>x.store_id && x.country && x.category_id);

    storesByKey = {};
    stores.forEach(s=>{
      const key = `${s.country}|${s.category_id}`;
      if(!storesByKey[key]) storesByKey[key]=[];
      storesByKey[key].push(s);
    });

    // products rows -> aggregate by product_id
    const byPid = {};
    pr.forEach(r=>{
      const pid = r.product_id;
      if(!pid) return;
      if(!byPid[pid]){
        byPid[pid] = {
          id: pid,
          name: r.name || "",
          spec: r.spec || "",
          category_id: r.category_id || "",
          photo: r.photo || "",   // optional (if later you add)
          twPricesByStore: {},    // store_id -> {priceTwd, note?}
          jpPricesByStore: {},    // store_id -> {untaxed, tax}
        };
      }
      // keep latest name/spec/category if provided
      if(r.name) byPid[pid].name = r.name;
      if(r.spec) byPid[pid].spec = r.spec;
      if(r.category_id) byPid[pid].category_id = r.category_id;

      const storeId = r.store_id;
      if(!storeId) return;

      const pTwd = numOrNull(r.price_twd);
      const pJu  = numOrNull(r.price_jpy_untaxed);
      const pJt  = numOrNull(r.price_jpy_tax);

      // Determine country by store registry if possible
      const store = stores.find(s=>s.store_id===storeId);
      const country = store ? store.country : "";

      if(country==="TW" && pTwd!=null){
        byPid[pid].twPricesByStore[storeId] = { priceTwd: pTwd };
      }
      if(country==="JP" && (pJu!=null || pJt!=null)){
        byPid[pid].jpPricesByStore[storeId] = { untaxed: pJu, tax: pJt };
      }
    });

    // build UI products with full store list display logic
    products = Object.values(byPid).map(p=>{
      const cat = categoriesById[p.category_id] || {name:p.category_id||"æœªåˆ†é¡", jpy_to_twd:0.2032, jp_tax_rate:0.10};
      const twList = (storesByKey[`TW|${p.category_id}`] || []).map(s=>{
        const price = p.twPricesByStore[s.store_id]?.priceTwd ?? null;
        return { name: s.store_name, store_id: s.store_id, priceTwd: price };
      });
      const jpList = (storesByKey[`JP|${p.category_id}`] || []).map(s=>{
        const it = p.jpPricesByStore[s.store_id] || {};
        let untaxed = (it.untaxed==null? null : it.untaxed);
        let tax = (it.tax==null? null : it.tax);

        // If only untaxed exists, compute tax by category rate
        if(untaxed!=null && tax==null){
          tax = Math.round(untaxed * (1 + (cat.jp_tax_rate ?? 0.10)));
        }
        return { name: s.store_name, store_id: s.store_id, untaxed, tax };
      });

      return {
        id: p.id,
        name: p.name,
        spec: p.spec,
        category_id: p.category_id,
        category_name: cat.name,
        fx: cat.jpy_to_twd,
        taxRate: cat.jp_tax_rate,
        photo: p.photo || "",
        twStores: twList,
        jpStores: jpList
      };
    });
  }

  // -------------------- Search ranking --------------------
  function scoreMatch(text, q){
    if(!q) return 9999;
    text = (text||"").toLowerCase();
    q = q.toLowerCase();
    if(text === q) return 0;              // perfect
    if(text.startsWith(q)) return 1;      // prefix
    const idx = text.indexOf(q);
    if(idx >= 0) return 10 + idx;         // contains earlier = better
    return 999999;
  }

  function renderList(){
    const wrap = document.getElementById("listWrap");
    const q = (document.getElementById("q").value||"").trim().toLowerCase();
    wrap.innerHTML = "";

    const filtered = products.filter(p=>{
      const hasTW = p.twStores.some(s=>s.priceTwd!=null);
      const hasJP = p.jpStores.some(s=>s.untaxed!=null || s.tax!=null);
      if(filter==="tw" && !hasTW) return false;
      if(filter==="jp" && !hasJP) return false;
      return true;
    });

    // rank
    const ranked = filtered.map(p=>{
      const s1 = scoreMatch(p.name, q);
      const s2 = scoreMatch(p.category_name, q) + 200;
      const storeNames = [...p.twStores.map(s=>s.name), ...p.jpStores.map(s=>s.name)].join(" ");
      const s3 = scoreMatch(storeNames, q) + 400;
      const best = Math.min(s1,s2,s3);
      return { p, best };
    }).filter(x=> q ? x.best < 999999 : true)
      .sort((a,b)=> a.best - b.best || a.p.name.localeCompare(b.p.name));

    ranked.forEach(({p})=>{
      // summary
      const hasTW = p.twStores.some(s=>s.priceTwd!=null);
      const hasJP = p.jpStores.some(s=>s.untaxed!=null || s.tax!=null);
      let tag = hasTW && hasJP ? "å°ç£ + æ—¥æœ¬" : hasTW ? "å°ç£" : "æ—¥æœ¬";

      const twMin = hasTW ? Math.min(...p.twStores.filter(s=>s.priceTwd!=null).map(s=>s.priceTwd)) : null;
      const jpVals = p.jpStores.flatMap(s=>[s.untaxed,s.tax]).filter(v=>typeof v==="number");
      const jpMin = jpVals.length ? Math.min(...jpVals) : null;
      const jpMinTwd = jpMin!=null ? Math.round(jpMin * (p.fx || 0.2032)) : null;

      const item = document.createElement("div");
      item.className = "item";
      item.onclick = ()=>openDetail(p);

      const th = document.createElement("div");
      th.className = "thumb";
      if(p.photo){
        const img=document.createElement("img");
        img.src=p.photo;
        th.appendChild(img);
      } else th.textContent="Photo";

      const mid = document.createElement("div");
      mid.style.flex="1";

      const nm = document.createElement("div");
      nm.className="name";
      nm.textContent=p.name;

      const sp = document.createElement("div");
      sp.className="spec";
      sp.textContent=`${p.spec || ""}  Â·  ${p.category_name || "æœªåˆ†é¡"}`;

      const meta = document.createElement("div");
      meta.className="meta";
      meta.innerHTML = `<div class="small">${hasTW?`å°ç£åº—:${p.twStores.length}`:"å°ç£åº—:0"} Â· ${hasJP?`æ—¥æœ¬åº—:${p.jpStores.length}`:"æ—¥æœ¬åº—:0"}</div>
                        <div class="tag">${tag}</div>`;

      const sum = document.createElement("div");
      sum.className="sum";
      if(hasTW && !hasJP){
        sum.innerHTML = `<strong>å°ç£æœ€ä½ NT$ ${twMin ?? "-"}</strong>`;
      } else if(!hasTW && hasJP){
        sum.innerHTML = `<strong>æ—¥æœ¬ç´„ NT$ ${jpMinTwd ?? "-"}</strong>ï¼ˆåŒ¯ç‡ ${p.fx}ï¼‰`;
      } else if(hasTW && hasJP){
        sum.innerHTML = `<strong>å°ç£ NT$ ${twMin ?? "-"} / æ—¥æœ¬ç´„ NT$ ${jpMinTwd ?? "-"}</strong>ï¼ˆåŒ¯ç‡ ${p.fx}ï¼‰`;
      } else {
        sum.textContent = "å°šæœªè¼¸å…¥åƒ¹æ ¼";
      }

      mid.appendChild(nm);
      mid.appendChild(sp);
      mid.appendChild(meta);
      mid.appendChild(sum);

      item.appendChild(th);
      item.appendChild(mid);
      wrap.appendChild(item);
    });

    if(!ranked.length){
      const e = document.createElement("div");
      e.className="small";
      e.style.margin="10px 2px";
      e.textContent = q ? "æ‰¾ä¸åˆ°ç¬¦åˆçš„å•†å“" : "ç›®å‰æ²’æœ‰è³‡æ–™ï¼ˆè«‹åˆ°è¨­å®šè¼‰å…¥ Google Sheetsï¼‰";
      wrap.appendChild(e);
    }
  }

  function openDetail(p){
    document.getElementById("d_title").textContent = p.name;
    document.getElementById("d_sub").textContent = `${p.spec || ""} Â· ${p.category_name || ""} Â· åŒ¯ç‡ 1JPYâ‰ˆ${p.fx}NTD Â· ç¨…ç‡ ${(p.taxRate*100).toFixed(0)}%`;

    const blocks = document.getElementById("d_blocks");
    blocks.innerHTML = "";

    // Taiwan block: show ALL stores in registry for this category (even if no price)
    const b1 = document.createElement("div");
    b1.className="block";
    b1.innerHTML = `<div class="bt">å°ç£ï¼ˆ${p.twStores.length} å®¶ï¼‰</div>`;
    p.twStores.forEach(s=>{
      const row = document.createElement("div");
      row.className="sr";
      row.innerHTML = `<div><div class="sn">${s.name}</div><div class="note">${s.priceTwd==null?"å°šæœªå¡«åƒ¹":""}</div></div>
                       <div class="sn">${s.priceTwd==null?"â€”":("NT$ "+s.priceTwd)}</div>`;
      b1.appendChild(row);
    });
    blocks.appendChild(b1);

    // Japan block: show ALL stores, compute tax if needed
    const b2 = document.createElement("div");
    b2.className="block";
    b2.innerHTML = `<div class="bt">æ—¥æœ¬ï¼ˆ${p.jpStores.length} å®¶ï¼‰</div>`;
    p.jpStores.forEach(s=>{
      const row = document.createElement("div");
      row.className="sr";

      const left = document.createElement("div");
      left.innerHTML = `<div class="sn">${s.name}</div><div class="note">${(s.untaxed==null && s.tax==null)?"å°šæœªå¡«åƒ¹":""}</div>`;

      const right = document.createElement("div");
      const lines = [];
      if(s.untaxed!=null){
        lines.push(`æœªç¨… ${s.untaxed}Â¥ï¼ˆç´„ NT$ ${Math.round(s.untaxed*(p.fx||0.2032))}ï¼‰`);
      }
      if(s.tax!=null){
        lines.push(`ç¨…å…¥ ${s.tax}Â¥ï¼ˆç´„ NT$ ${Math.round(s.tax*(p.fx||0.2032))}ï¼‰`);
      }
      right.innerHTML = lines.length ? lines.map(l=>`<div class="line">${l}</div>`).join("") : `<div class="sn">â€”</div>`;

      row.appendChild(left);
      row.appendChild(right);
      b2.appendChild(row);
    });
    blocks.appendChild(b2);

    document.getElementById("bd").classList.add("active");
  }

  // -------------------- Settings actions --------------------
  function saveSheetId(){
    const v = document.getElementById("sheetInput").value.trim();
    if(!v){ alert("è«‹è²¼ä¸Šè©¦ç®—è¡¨ç¶²å€æˆ– Sheet ID"); return; }
    localStorage.setItem(KEY_SHEET, v);
    updateSourceInfo();
    alert("å·²å„²å­˜ã€‚å»ºè­°æŒ‰ã€Œè¼‰å…¥è³‡æ–™ã€æ¸¬è©¦ã€‚");
  }

  function updateSourceInfo(usingCache=false){
    const raw = localStorage.getItem(KEY_SHEET) || "";
    const id = extractSheetId(raw);
    const el = document.getElementById("sourceInfo");
    if(!id){
      el.textContent = "å°šæœªè¨­å®šã€‚è«‹åˆ°ã€Œè¨­å®šã€è²¼ä¸Šè©¦ç®—è¡¨ç¶²å€æˆ– Sheet IDã€‚";
      return;
    }
    el.textContent = `ç›®å‰ Sheet IDï¼š${id}${usingCache?"ï¼ˆé¡¯ç¤ºå¿«å–ï¼‰":""}`;
    document.getElementById("sheetInput").value = raw;
  }

  // -------------------- Boot --------------------
  updateSourceInfo();

  // If cache exists, show something immediately
  const cache = localStorage.getItem(KEY_CACHE);
  if(cache){
    try{
      const data = JSON.parse(cache);
      buildDataModel(data.cats||[], data.st||[], data.pr||[]);
      renderList();
    }catch(e){}
  }
</script>
</body>
</html>
